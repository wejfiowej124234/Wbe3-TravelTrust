# 多维度文档与技术检查报告

本文档为**文档缺口**与**技术问题**（含与文档的对应关系）的多维度检查结果，覆盖前端、后端、区块链与智能合约、08 门禁与证据。**用途**：发版前/定稿前逐项闭合；实现时按「技术问题」落代码与配置。文档版本与最后更新见 [00-文档索引](00-文档索引.md)。

**本文结构**：一 文档缺口（按维度）→ 二 技术问题（与文档对应）→ 三 建议修补项（已落实）→ 四 总结 → 五 全方位文档检查结论 → **六 多维度·深度·企业级检查**（文档×代码 SSOT、08 闭环、合规/安全/运维、可观测、缺口汇总）。

---

## 一、文档缺口（按维度）

### 1.1 通用/00/08 定稿类（发版前必填）

| # | 缺口 | 位置 | 建议 |
|---|------|------|------|
| 1 | 00 版本表 15 篇（含本报告） | 00 文档版本与最后更新表 | 已补齐占位（0.1.0-draft / 2025-02-20）；定稿/发版时须替换为正式版本号与日期 |
| 2 | 08-4 定稿日期、法务/运营签字未填 | 08-4 文末 | 已标注「定稿时填」；定稿时必填 |
| 3 | 08-2 工单 Owner 部分仍为角色名 | 08-2 优先 6 项、上线就炸 11 项 | 已改为「法务（定稿时落责任人）」等占位 |
| 4 | 08-2 深层机制 #12～#22、一致性与演化表 Owner | 08-2 深层机制、一致性与冲突检测、演化五类 | 已补齐：已统一为「角色（定稿时落责任人）」 |
| 5 | 08-2 发版前审查一/二 未勾选处 | 发版前审查一、二 | 已注明「未勾选处须定稿时勾选并填审查人/日期」 |
| 6 | Runbook P0 九项多未填 | ops/RUNBOOK.md 定稿表 | 已注明「发版前须将 P0 九项全部填实（定稿时填）」 |
| 7 | evidence 真实 bundle | evidence/GO_YYYYMMDD/ | 属运营/过门动作；仓内保留 README 与模板，不代造真实 GO_* |

### 1.2 前端（05/06）

| # | 缺口 | 位置 | 建议 |
|---|------|------|------|
| 1 | **05 §四 骨架与当前实现不一致** | 05 §四 前端仓库骨架 | 05 描述为 pages/auth/、me/、**tourist/**、**guide/**、**arbitrator/** 子目录；当前 crates/web 为**扁平** pages（Home/Auth/Me/Orders/Disputes）。建议在 05 §四 注明：「当前实现为扁平 pages（Home、Auth、Me、Orders、Disputes）；Phase 4 可按上表拆为 tourist/guide/arbitrator 子目录。」 |
| 2 | 05 §五 模块职责与当前 pages 对应 | 05 §五 | 当前仅有 PageHome/PageAuth/PageMe/PageOrders/PageDisputes；与 §五 的 tourist/guide/arbitrator 分页为规划，实现时按 Phase 4 补齐 |
| 3 | 可验证发布（manifest+hash） | 05、08-4 第 7 章、W-Q6-FE | 文档已要求；前端构建产物与校验步骤**实现时定稿**，当前未产出 |
| 4 | 06 §6.3 开工前检查清单 | 06 | 已存在且与 07 §4.3 衔接，无缺口 |

### 1.3 后端（04）

| # | 缺口 | 位置 | 建议 |
|---|------|------|------|
| 1 | **证据 API 路径占位** | 04 §三 证据段落 | 已闭合：api 已增加 `GET/POST /api/v1/orders/:id/evidence` 返回 501 占位，与 04「实现时定稿」一致；实现时与 01 §6 定稿 |
| 2 | 支付回调/webhook 路径 | 04 §三 支付与链上 | 已写「由实现定稿」，无矛盾 |
| 3 | KYC 预留接口 | 04 §三 3.2、§五 Phase 4 | 已写 Phase 4 定稿，无缺口 |

### 1.4 区块链与智能合约（01/02/contracts）

| # | 缺口 | 位置 | 建议 |
|---|------|------|------|
| 1 | **01 未直接引用 contracts/README** | 01 §4 智能合约、§8 骨架 | 01 骨架列 contracts/，但未写「合约设计承诺与实现状态见仓库 [contracts/README](../contracts/README.md)」。建议在 01 §4 或 §8 骨架处加一句，便于从 01 跳转到合约实现状态 |
| 2 | 02 §十 与 contracts/README 一致 | 02 §十、contracts/README | 已一致：02 写「contracts/ 当前为设计态」；contracts/README 写「待实现」 |
| 3 | 合约实现状态（Escrow/Staking/Registry） | contracts/ | 无 Solidity 代码，仅 README；文档已多处「待实现」「设计态」，无矛盾 |
| 4 | 部署前 08-3 校验、链上 SSOT hash | 08-5、Runbook §10 | Runbook §10 已注明「部署前 08-3 校验—待实现」；Backend 启动 SSOT 已实现 |

### 1.5 07/08 与 evidence

| # | 缺口 | 位置 | 建议 |
|---|------|------|------|
| 1 | 07 §4.3 发版前检查与 00 发版前快速核对 | 07、00 | 已对齐：07 含 08 P0 门禁、evidence、Runbook P0、00 发版前快速核对 |
| 2 | 08-2 Gate 汇总、W-PDP-SSOT、W-GATE-CROSS-CHECK | 08-2 | 已就位；CI/PR 模板见 08-5 |

---

## 二、技术问题（与文档对应）

### 2.1 后端（crates/api）

| # | 技术点 | 文档依据 | 当前状态 | 说明 |
|---|--------|----------|----------|------|
| 1 | 全量路由（04 §三） | 04 §三 路由表 | ✅ 已对齐 | /health、auth/*、/api/v1/me、me/stats、me/password、guides、orders、disputes 均已挂载 |
| 2 | x-request-id（traceId） | 01 §9、04 §四 | ✅ 已实现 | 请求头带入或生成，响应头回写 |
| 3 | 幂等键 Idempotency-Key/X-Idempotency-Key | 01 §10 #14、04 §四 | ✅ 占位已就位 | 中间件读取并回写响应头；实现时在此做 key 去重与结果复用 |
| 4 | 请求体 1MB、超时 30s | 04 §四 | ✅ 已实现 | RequestBodyLimitLayer、TimeoutLayer |
| 5 | CORS_ORIGINS、生产必设 | 04 §四、README | ✅ 已实现并强调 | 未设则开发态允许任意；README/04 已提醒生产必设 |
| 6 | STRICT_SSOT、SSOT_VERSION | 08-5 §4、Runbook §10 | ✅ 已实现 | 启动时校验，STRICT_SSOT=1 未设置则拒绝启动 |
| 7 | 证据路由 POST/GET evidence | 04 §三 证据 | ✅ 占位已就位 | GET/POST /api/v1/orders/:id/evidence 返回 501，实现时与 01 §6 定稿 |
| 8 | 鉴权（JWT/session） | 04 §三、§四 | 占位透传 | 实现时替换 auth_placeholder_layer |

### 2.2 前端（crates/web）

| # | 技术点 | 文档依据 | 当前状态 | 说明 |
|---|--------|----------|----------|------|
| 1 | 路由 yew-router | 05 §三 | ✅ 已实现 | /、/auth、/me、/orders、/disputes、/404 |
| 2 | API 基地址 VITE_API_BASE_URL | 05 §四 | ✅ 已实现 | api/mod.rs 用 option_env!("VITE_API_BASE_URL")，默认 localhost:3000 |
| 3 | 页面与 05 §四§五 对应 | 05 §四§五 | ⚠️ 骨架差异 | 当前扁平 5 页；05 描述为 tourist/guide/arbitrator 子目录，属 Phase 4 目标 |
| 4 | get_health、get_me | 04 §三、05 | ✅ 已占位 | 首页调用 get_health 示例；get_me 已声明 |
| 5 | 可验证发布（manifest+hash） | 08-4 第 7 章、W-Q6-FE | 待实现 | 构建产物与校验步骤实现时定稿 |

### 2.3 区块链与智能合约

| # | 技术点 | 文档依据 | 当前状态 | 说明 |
|---|--------|----------|----------|------|
| 1 | Escrow/Staking/Registry（方案 B） | 01 §4、02 §十、contracts/README | 待实现 | contracts/ 无 Solidity 代码；README 与 01/02 一致 |
| 2 | 无 admin/无 emergency withdraw | 08-4、contracts/README | 设计承诺 | 实现时须与承诺一致 |
| 3 | 链上事件 EscrowCreated/Paid/DisputeOpened/ResolutionExecuted | 01 §5、02 §七 | 待实现 | 合约与 indexer/对账实现时落地 |
| 4 | 部署前 08-3 校验、链上 SSOT hash | 08-5、Runbook §10 | 待实现 | Runbook 已注明「待实现」 |

### 2.4 文档与实现一致性（交叉）

| # | 项 | 说明 |
|---|-----|------|
| 1 | 04 §三 与 crates/api 路由 | 已逐条对齐，无遗漏 |
| 2 | 05 §四 骨架与 crates/web 目录 | 05 已注明当前实现为扁平 pages、Phase 4 可拆子目录，与实现一致 |
| 3 | 01 §8 骨架与仓库根 README | README 实现状态与 08-0 §十二、01 骨架一致；chain-client 可选、contracts 设计态已说明 |
| 4 | 07 Phase 与 04 §五、06 Phase 3/4 | 对应关系已在 07 §三、§二 载明，无缺口 |

---

## 三、建议修补项（已落实）

1. **05 §四**：已落实 — 已加「**当前实现**：为扁平 pages（Home、Auth、Me、Orders、Disputes）…Phase 4 可拆子目录。」
2. **08-2**：已落实 — 深层机制 #12～#22、一致性与冲突检测表、演化五类表 Owner 列已统一为「角色（定稿时落责任人）」。
3. **01**：已落实 — §4 与 §8 骨架已增加 contracts/README 引用。
4. **证据路由**：已落实 — api 已增加 `GET/POST /api/v1/orders/:id/evidence` 返回 501 占位。
5. **00 版本表**：已落实 — 14 篇已填占位版本（0.1.0-draft）与日期（2025-02-20），定稿时替换为正式版本与日期。
6. **evidence 校验脚本**：已落实 — scripts/validate-evidence-manifest.sh 已新增（依赖 jq；无 jq 时人工核对）。
7. **幂等 key 去重与结果复用**：已落实 — crates/api 对 POST/PUT 按 Idempotency-Key 缓存响应（最多 1000 条），重复请求返回缓存结果（01 §10 #14）。
8. **部署前 SSOT 校验脚本**：已落实 — scripts/check-ssot-deploy.sh，部署前执行；STRICT_SSOT=1 或 CHECK_SSOT=1 时要求 SSOT_VERSION。
9. **17 条验收清单**：已落实 — scripts/checklist-17.md，逐条勾选用；实现时填 artifact 路径。
10. **前端可验证发布脚本**：已落实 — scripts/build-frontend-manifest.sh，构建后在 dist/ 生成 manifest.json + manifest.sha256（08-4 第 7 章、W-Q6-FE）。
11. **定稿时填显式占位**：已落实 — 08-4 定稿日期/法务/运营签字行已加「__________」；08-2 审查一加「待审」说明；Runbook P0 加填写说明。
12. **定稿时操作与填写说明**：已落实 — 00 版本表下增加「定稿时操作」段（替换 0.1.0-draft 为正式版本与日期）；08-2 表头前增加「定稿时填写说明」（Owner 落人、审查一/二填写要点）；Runbook P0 九项「定稿时须填写」列均加「→ __________」填格占位；evidence/README 末增加「缺口说明」（真实 bundle 须过门时产出，仓内无其他可补齐缺口）。
13. **部署前 SSOT 与 08-4 版本比对**：已落实 — scripts/check-ssot-deploy.sh 在 STRICT=1 时可选比对 SSOT_VERSION 与 08-4 文末版本，不一致时 WARN（不阻断）。
14. **可观测（请求日志）**：已落实 — crates/api request_id_layer 每请求打印 x-request-id、path、status（01 §9 traceId 贯通；实现时可接入结构化日志/SLO）。

---

## 四、总结

- **文档缺口**：**已补齐**：00 版本表、05 §四、01 引用 contracts、08-2 Owner 占位、证据路由与 evidence 校验脚本、08-4/08-2/Runbook 定稿时填显式占位与填写说明均已就位。**定稿/发版时须人工执行**：08-4 定稿日期与签字填实、08-2 Owner 落具体人、发版前审查一/二勾选与填写、Runbook P0 九项填实、evidence 真实 bundle 产出。
- **技术问题**：后端与 04 已对齐（含证据占位路由、traceId、**幂等 key 去重与结果复用**、超时、体限、CORS、SSOT）；部署前 SSOT 脚本、17 条验收清单、前端可验证发布脚本已就位；合约/链上部署前 08-3 版本比对仍为「待实现」且已留痕。
- **企业级审计结论**入口已放在 README，见 [08-0 §十一～§十四](08-0-系列审计-命名排序与合并瘦身.md)。

---

## 五、全方位文档检查结论（本轮）

**检查范围**：docs/ 下全部 15 篇（00～08-5、多维度文档与技术检查报告）、README、ops/RUNBOOK.md、evidence/README.md、contracts/README.md。

| 检查项 | 结果 | 说明 |
|--------|------|------|
| 文档版本表 | ✅ | 00 版本表已含 14 篇 + 多维度报告（共 15 行），占位版本 0.1.0-draft/日期 2025-02-20；说明已更新为「占位表示待定稿」 |
| 各文档「版本见 00」 | ✅ | 01～08-5、多维度报告开篇或文末均有「文档版本与最后更新见 [00-文档索引]」 |
| 08-2 全表 Owner 占位 | ✅ | 优先 6 项、上线就炸 11 项、深层 #12～#22、一致性与冲突检测、演化五类表 Owner 已统一为「角色（定稿时落责任人）」 |
| 证据路由与脚本 | ✅ | API 已挂 GET/POST /api/v1/orders/:id/evidence（501）；scripts/validate-evidence-manifest.sh 已就位 |
| 01 引用 contracts | ✅ | 01 §4、§8 已引用 contracts/README |
| 05 当前实现说明 | ✅ | 05 §四 已注明当前实现为扁平 pages、Phase 4 可拆子目录 |
| 00 目录结构 | ✅ | 已含多维度报告、scripts 双脚本 |
| README 文档入口 | ✅ | 已链 08-0 企业级审计结论、多维度文档与技术检查报告 |
| 08-1 锚点引用 | ✅ | 05/06/07 引用 08-1#附录上线-go-no-go-gate发布级门禁、08-2 引用 08-1#上线就炸续12～22-项须写死深层机制与优先级，08-1 内标题存在，锚点可解析 |
| 08-3 26 key | ✅ | 08-3 表已填满 value / who_can_change / change_process / evidence_pointer 等列，无裸「待填」 |

**仍须定稿/发版时人工执行的缺口**（仓库内不代填）：① 08-4 定稿日期、法务/运营签字 ② 08-2 工单 Owner 落具体责任人（姓名或代号）及 backup ③ 08-2 发版前审查一 11 行勾选与审查人/日期/结论 ④ 08-2 发版前审查二 最后更新/评审日期/Evidence 路径 ⑤ Runbook P0 九项具体内容（值班人、冲突矩阵步骤表、法律突变策略等）⑥ evidence 真实 GO_YYYYMMDD bundle 产出（过门时按模板填写并入仓）。

---

## 六、多维度·深度·企业级检查

从**文档×代码 SSOT**、**08 闭环**、**合规/治理/安全/运维**、**可观测**四维做深度扫描；结论区分「定稿时填」「可实现但未做」「已闭合」。

### 6.1 文档×代码 SSOT 与可追溯

| 维度 | 检查项 | 状态 | 说明 |
|------|--------|------|------|
| 04↔api | 路由与 04 §三 全量对齐 | ✅ | main.rs 已挂 /health、auth/*、/api/v1/me、me/stats、me/password、guides、orders、orders/:id/accept|cancel|confirm-completion|reviews|**evidence**|dispute、disputes、disputes/:id/resolve；evidence 为 501 占位 |
| 01 §9 | traceId（x-request-id） | ✅ | 请求头带入或生成，响应头回写；与 01 §9 requestId→txHash→logIndex 贯通一致 |
| 01 §10 #14 | 幂等键 | ✅ | POST/PUT 按 key 去重并复用缓存响应（最多 1000 条）；GET 等透传并回写 key |
| 01 §10 17 条 | 证据产物/单测/E2E | ⚠️ 实现期 | 01 §10 审计验收表已列 17 条与 artifact；实现时逐条落单测/E2E/对账脚本，可产出 Evidence |
| 01 §10 12 缝 | 12 缝→08-3/03 对照表 | ✅ | 01 §10 已含 12 缝→08-3/03 参数 key 对照表、12 缝→17 条验收编号对照表 |
| 04 §四 | 请求体 1MB、超时 30s、CORS | ✅ | RequestBodyLimitLayer 1MB、TimeoutLayer 30s；CORS_ORIGINS 可配置，生产必设已写 README/04 |
| 08-5/Runbook §10 | SSOT 启动校验 | ✅ | STRICT_SSOT=1 时 SSOT_VERSION 未设置则拒绝启动；Runbook §10、08-5 §4 已注明 |

### 6.2 08 闭环（CI / 映射表 / 部署前）

| 维度 | 检查项 | 状态 | 说明 |
|------|--------|------|------|
| 脚本 KEYS | 与 08-3 映射表 15 key 一致 | ✅ | check-08-consistency.sh 中 KEYS 含 ofacHitPolicy、pauseCooldown、pauseAllowlist、evidence 三 key、arbFeeBase/Cap、fxDisplayPolicy、paramChangeMaxPer30d、paramFreezeDays、freezeDisputePolicy、serviceStartTimeSource、minArbitratorCount、chargebackPolicy；与 08-3 映射表一致 |
| CI workflow | 08-3/08-4 变更时跑脚本 | ✅ | 08-5 已列 .github/workflows/check-08-consistency.yml、build.yml；PR 改 08-3 或 08-4 时跑校验 |
| PR 模板 | 受影响的 param_key、08-4 版本号 | ✅ | 08-5 已列 .github/PULL_REQUEST_TEMPLATE.md 必填项 |
| 部署前 SSOT 校验 | 部署前要求 SSOT_VERSION | ✅ 已就位 | scripts/check-ssot-deploy.sh：STRICT_SSOT=1 或 CHECK_SSOT=1 时未设置 SSOT_VERSION 则 exit 1；合约/链上 08-3 版本比对仍待实现 |
| 08-4 版本行 | 文末「文档版本（CI 校验用）」可机读 | ✅ | 08-4 已设该行；脚本以「文档版本」+ 版本号格式校验 |

### 6.3 合规/治理/安全/运维

| 维度 | 检查项 | 状态 | 说明 |
|------|--------|------|------|
| 08-4 定稿三要素 | 版本号、定稿日期、法务/运营签字 | ⚠️ 定稿时填 | 文末已标注「定稿时填」；缺一不可作为门禁闭合证据 |
| 08-2 审查一/二 | 11 行勾选、审查人/日期、Evidence 路径 | ⚠️ 定稿时填 | 表已就位，未勾选处须定稿时勾选并填审查人/日期 |
| Runbook P0 | 9 项具体内容（值班/批准人、冲突矩阵等） | ⚠️ 定稿时填 | 已注明「发版前须将 P0 九项全部填实（定稿时填）」 |
| 08-3 26 key | value / who_can_change / evidence_pointer 填满 | ✅ | 无裸「待填」；evidence_pointer 已落 Runbook §N 或 08-3 变更记录 |
| 密钥/敏感信息 | 不落仓、.env.example 无秘密 | ✅ | .env.example 仅 SSOT_VERSION、STRICT_SSOT、PORT、CORS_ORIGINS；Runbook 值班/批准「脱敏或代号」 |
| 证据链三条 | 上传回执、访问留痕、争议保全冻结 | ✅ 文档 | Runbook §5、08-1 K 9️⃣、08-4 第 3 章已写死；实现时与 01 §6 定稿 |

### 6.4 可观测与运维

| 维度 | 检查项 | 状态 | 说明 |
|------|--------|------|------|
| traceId 贯通 | requestId→messageId→txHash→logIndex | ✅ 部分 | API 层 x-request-id 已就位；对账/执行器 messageId 与 x-request-id 关联方式由实现定稿（04 §四已写） |
| 日志/指标 | 请求级日志（traceId+path+status）、SLO 六项 | ✅ 部分 | 每请求 eprintln x-request-id/path/status；SLO 阈值与动作实现时落 01 §9 |
| Runbook §1 触发表 | 七场景阈值/自动动作/人工动作/证据产物 | ✅ 文档 | 表已填；值班/批准「定稿时落具体联系人或代号」 |

### 6.5 企业级缺口汇总

| 类别 | 内容 | 责任 |
|------|------|------|
| **仅定稿/发版时填** | 08-4 定稿日期与签字；08-2 Owner 落人、审查一/二勾选与填写；Runbook P0 九项；00 版本表 15 篇填实；evidence 真实 GO_YYYYMMDD | 法务/运营/运维/发版负责人 |
| **可实现但未做（留痕）** | 17 条逐条单测/E2E/对账 Evidence（清单已就位，实现时勾选）；合约/链上部署前 08-3 版本比对（待实现）；SLO/日志/指标落地 | 实现阶段按 01 §10、04、Runbook 闭合 |
| **已闭合** | 04 与 api 路由对齐、traceId、**幂等 key 去重与结果复用（POST/PUT 缓存 1000 条）**、证据 501 占位、CORS/体限/超时、STRICT_SSOT 启动校验、08-3 映射与脚本 KEYS 一致、CI/PR 模板、01 12 缝→08-3/17 条对照表、08-2 全表 Owner 占位、evidence 校验脚本、**部署前 SSOT 脚本**（scripts/check-ssot-deploy.sh）、**17 条验收清单**（scripts/checklist-17.md）、**前端可验证发布脚本**（scripts/build-frontend-manifest.sh）、08-4/08-2/Runbook 定稿时填显式占位 | — |

**企业级结论**：文档与 01～08 权威链、08-3/08-4/CI 一致；代码与 04 §三、01 §9/§10 已对齐至占位与约束层。**剩余缺口**分为两类：① **定稿/发版时人工必填**（08-4 三要素、08-2 审查与 Owner、Runbook P0、evidence bundle）② **实现期闭合**（幂等去重、17 条证据产物、部署前 SSOT 校验、可验证发布、SLO/日志）。发版前按 00「发版前快速核对」与 08-0 §八 自检表、本报告 §五/§六 逐项勾选即可。

*本报告与 00～08、ops/RUNBOOK、README、contracts/README 配套。*
