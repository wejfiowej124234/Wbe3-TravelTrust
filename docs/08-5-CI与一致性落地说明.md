# 08-5 CI 与一致性落地说明

本文档说明如何在仓库中落地 [08-2](08-2-附录-闭合工单表.md) 中的 **W-PDP-SSOT-CONSISTENCY** 与 **W-DRIFT-CI** 检查，使 08-3 关键 key 与 08-4 版本号同步可机读、可阻断。**08 系列序号**：08-5 与 08-1～08-4 统一数字序号，便于排序与索引，见 [08-0](08-0-系列审计-命名排序与合并瘦身.md)。

**依据**：08-2「仓库 CI 落地清单」、08-3「关键 key 与 08-4 章节映射」表。

---

## 1. 已入仓的产物

| 产物 | 路径 | 说明 |
|------|------|------|
| PR 模板 | [.github/PULL_REQUEST_TEMPLATE.md](../.github/PULL_REQUEST_TEMPLATE.md) | 必填：受影响的 param_key、08-4 章节、08-2 workitem_id、08-4 版本号是否已更新 |
| 校验脚本 | [scripts/check-08-consistency.sh](../scripts/check-08-consistency.sh) | 若 diff 触及 08-3 映射 key，则 08-4 须含「文档版本（CI 校验用）」行变更，否则 exit 1 |
| CI workflow（08 文档） | [.github/workflows/check-08-consistency.yml](../.github/workflows/check-08-consistency.yml) | PR 改动 docs/08-3 或 08-4 时自动运行上述脚本 |
| CI workflow（构建） | [.github/workflows/build.yml](../.github/workflows/build.yml) | push/PR 时 `cargo build --workspace` 与 `cargo test --workspace`，确保 crates 可编译通过 |
| 环境变量示例 | [.env.example](../.env.example) | Backend 用：SSOT_VERSION、STRICT_SSOT、PORT、CORS_ORIGINS；见 Runbook §10、04 §四 |

---

## 2. 使用校验脚本

在仓库根目录执行（需 Git）：

```bash
# 与上一提交比较（单次提交）
./scripts/check-08-consistency.sh

# 与 main 比较（PR 场景，CI 中 BASE_REF=main）
./scripts/check-08-consistency.sh main
```

**规则**：脚本对 **docs/08-3-参数与门禁表.md**、**docs/08-4-对外口径包.md** 做 diff；若 08-3 变更触及映射表中任一 param_key（含 ofacHitPolicy、pauseCooldown、pauseAllowlist、evidenceRetentionDays、evidenceMaxSize、evidenceTypeAllowlist、arbFeeBase、arbFeeCap、fxDisplayPolicy、paramChangeMaxPer30d、paramFreezeDays、freezeDisputePolicy、serviceStartTimeSource、minArbitratorCount、**chargebackPolicy**），则 08-4 变更须包含「文档版本（CI 校验用）」行及版本号，否则脚本返回非零。

---

## 3. 在 CI 中接入（示例）

本仓库已包含 **.github/workflows/check-08-consistency.yml**：在 PR 修改 `docs/08-3*.md` 或 `docs/08-4*.md` 时自动运行校验脚本，未通过则 workflow 失败。

**自行接入时**，在 PR 触发的工作流中增加一步，例如：

```yaml
- name: Check 08-3 / 08-4 consistency
  run: ./scripts/check-08-consistency.sh ${{ github.event.pull_request.base.sha }}
```

若仓库使用其他 CI（GitLab、Jenkins 等），在 PR 构建中执行上述脚本并将退出码非零视为失败即可。**Fork PR**：CI 以**同仓 PR**为设计假设；若 PR 来自 fork 且 `base.sha` 不可用导致校验失败，可重跑 workflow 或由维护者确认后合并，见 workflow 文件注释。

---

## 4. 部署前与运行时校验（推荐）

08-2 要求：合约/升级代理**部署前**校验 08-3 参数表版本或关键 key，未通过则阻断部署；**Backend 启动时**应做 SSOT 运行时校验，避免「文档正确、运行错误」。

**部署前**（部署脚本中）：
- 读取 `docs/08-3-参数与门禁表.md` 中约定版本或关键 key 列表；
- 与当前部署所用配置/合约参数比对，不一致则 abort。

**合约升级时（企业级必选）**：**升级脚本须强制校验 SSOT 版本 hash**（如 08-3 或约定 SSOT 文件的 hash）；**不一致则拒绝部署**。若升级脚本可绕开 SSOT，**文档闭环仅为仓库层面约束**；企业级审计会问「**链上是否有 enforce 机制**」—须在**链上或部署管线**有强制读取 08-3 hash 并拒绝升级的机制，写死并落地。见 08-2 防参数外改。**文档闭环 vs 链上 enforce（2️⃣）**（写死）：若**仅仓库 CI enforce**（PR 阻断）而**链上/部署可绕开**（如升级脚本不校验 SSOT hash、部署不校验 08-3 版本），审计结论会写：**Governance is process-based, not protocol-enforced**。须写死：**升级脚本是否强制读取 SSOT hash**、**部署脚本是否必须校验 08-3 版本**；二者至少其一须为「是」并落地，否则须在 08-4 或 Runbook 明确「当前为 process-based，链上 enforce 计划见路线图」。

**Backend 启动时（SSOT 运行时校验）**：
- 校验或打印当前 SSOT 版本/hash（与 08-3 或约定版本一致）；
- 链上读取参数与 08-3 关键 key 比对（若适用）；
- 与 08-2「防参数外改」一致；未通过则告警或拒绝启动。

具体实现由运维/架构按部署链路自行接入。

**落点说明（企业级）**：**Backend 启动 SSOT 校验已实现**，落点见 [Runbook §10](../ops/RUNBOOK.md)（crates/api 启动时读取 env SSOT_VERSION，STRICT_SSOT=1 时未设置则拒绝启动）。**部署前 SSOT 校验脚本已就位**：`scripts/check-ssot-deploy.sh`，部署/升级前执行；当 `STRICT_SSOT=1` 或 `CHECK_SSOT=1` 时要求 `SSOT_VERSION` 已设置，否则 exit 1。合约/链上部署前 08-3 版本比对仍为「待实现」，须在 Runbook §10 或部署管线中写死落点；定稿时须勾选「已实现」或「待实现」并留痕。CI 仅覆盖 PR 层 08-3/08-4 同步；部署与运行时校验为独立技术闭环。

---

## 5. 清单勾选

实施时可在 08-2「仓库 CI 落地清单」中勾选：

- □ PR 模板已增加「受影响的 param_key」「08-4 章节」「08-2 workitem_id」「08-4 版本号是否已更新」
- □ CI workflow 已调用 `scripts/check-08-consistency.sh`（或等价逻辑），未通过则 fail
- □（可选）部署/升级脚本已读取 08-3 版本或 key 与当前参数比对
- □（推荐）Backend 启动时 SSOT 校验或打印版本/hash、与 08-3 比对
- □（企业级）**合约升级时**：升级脚本强制校验 SSOT 版本 hash（如 08-3 或约定文件 hash），不一致则拒绝部署；避免升级代理绕开 SSOT 导致链上与文档脱节

*本文与 [08-2-附录-闭合工单表](08-2-附录-闭合工单表.md)、[08-3-参数与门禁表](08-3-参数与门禁表.md) 配套。*
