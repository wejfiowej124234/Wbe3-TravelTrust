# TrustLayer / TravelTrust 架构设计

本文为 **TrustLayer**（面向全球旅行服务的**去中心化协议**）的架构设计，与 [01-总库总览](01-总库总览.md) 项目定位及 P0 一致。协议定位为去中心化：链上为资金与状态真相，治理多签+TimeLock，运营层可演进。仓库名 TravelTrust，产品与目标为 TrustLayer。

**与总览主题对齐**：本架构支撑 01 三大能力——**安全预订**（订单与档期、状态机、超时与取消）；**担保支付**（Escrow、链为准、事件驱动、双签/争议后执行）；**可验证信誉**（仅资金终态可评价、可存证，见 01 Sybil 与评价 P0）。双角色（游客/导游）、导游质押申请身份（Registry+Staking）、方案 B 准入与 01 一致。**架构类型**：**去中心化协议**，技术形态为混合（链上资金与信任 + 链下业务与检索），链为准、DB 为缓存与检索。

**内容与结构**：§一 共性目标 · §二 分层 · §三 领域切分 · §四 状态机 · §五 钱和链 · §六 安全合规 · §七 事件/对账/执行器 · §八 数据流 · §九 架构决策点 · §十 合约对应（含**功能与参考实例对照**）· §十一 小结 · §十二 非功能与运维 · **§十三 架构级检查清单（安全·流程·审计）**。涵盖分层与子域、状态机与钱链抽象、安全合规、事件消费与对账、12 缝/8 项决策点、合约与参考实例及实现/审计前检查清单。

**受众与用法**：架构师、开发负责人、审计对接人。建议先读 01 再读本文，实现时与 [04-后端与API](04-后端与API.md)、[05-前端总览](05-前端总览.md)、[06-DApp架构总览](06-DApp架构总览.md)、[07-开发流程与顺序](07-开发流程与顺序.md) 配套。审计时以本文与 01 对照，确认分层与子域、链与 DB 边界、权限与执行器、12 缝/8 项/17 条可追溯。**文档维护责任**：架构师或技术负责人；架构变更须评审后更新本文并同步 01 相关节。文档版本与最后更新见 [00-文档索引](00-文档索引.md)。

---

## 一、项目共性及架构目标

| 维度 | 特点 | 架构影响 |
|------|------|----------|
| **多角色** | 游客、导游、仲裁员、平台方；注册可双角色（游客/导游），导游需质押申请身份 | 权限与上下文分离、不同端不同入口；Registry+Staking 准入 |
| **资金与信任** | 托管（Escrow）、放款、退款、扣罚 | 状态机清晰、链上事件为准、审计可追溯、不能丢钱 |
| **信誉** | 评分、防刷、权重、可验证存证 | 与「资金终态订单」强绑定、可独立成领域；见 01 Sybil 与评价 P0 |
| **争议** | 证据、仲裁、裁决执行（链上执行器） | 工作流明确、裁决后链上执行至资金终态 |
| **合规与链** | KYC 链下、资金与资格链上（方案 B） | 链为准、DB 为缓存；链抽象为端口便于测试/多 RPC，MVP 实现为链上 |

架构设计围绕：**清晰分层、领域边界、链与 DB 分工明确、可审计**。与 01 总库总览 P0 及链与代币选型一致。

**主题符合性自检**：下表为与 01 总览主题的逐项对照，实现与审计时须保持一致。

| 01 总览主题/约束 | 02 架构对应 | 所在节 |
|------------------|-------------|--------|
| TrustLayer、全球旅行、去中心化协议 | 开篇定位、§一 项目共性、技术形态为混合 | 开篇、§一、§二 |
| 安全预订、担保支付、可验证信誉 | 开篇「与总览主题对齐」、订单/档期、Escrow、Reputation 子域 | §三、§四、§十 |
| 双角色、导游质押申请身份 | §一 多角色；§三 导游市场(Registry+Staking)；§四 导游状态机 | §一、§三、§四 |
| 双方确认后才上链、链上事件为准 | §四 主流程；§五 链为准；§七 事件消费 | §四、§五、§七 |
| 链为准、DB 为缓存、对账+幂等 | §五 钱和链；§六 DB·写边界；§七 对账 | §五、§六、§七 |
| 12 缝、8 项、17 条、系统级不变量 | §九 架构决策点；§十 合约对应；§十一 小结 | §九、§十、§十一 |
| 资损 runbook 5 条、E2E/发布 | §十一、§十二（韧性/对账）；01 §9 发布与 E2E | §十一、§十二 |
| 参考实例与检查清单 | §十 功能与参考实例对照；§十三 架构级检查清单 | §十、§十三 |
| Web 与 DApp 业务数据同源 | §八 数据流（同源说明）；01 §9、[05](05-前端总览.md)、[06](06-DApp架构总览.md) | §八 |

**02 与 01 关键一致性核对**（维护时以 01 为权威，02 不得与之冲突）：

| 核对项 | 01 位置 | 02 位置 | 结论 |
|--------|---------|---------|------|
| 订单状态枚举与资金终态 | §1 状态机表；Disputed→Refunded/PartiallyRefunded/Slashed/Completed | §四 状态机、主流程、状态×操作×执行者表 | 一致 |
| 链为准 / DB 为缓存 | §3 链 vs DB；§5 事件驱动 | §五 钱和链；§六 DB·写；§七 事件消费 | 一致 |
| 四类链上事件 | §5 四 EscrowCreated/Paid/DisputeOpened/ResolutionExecuted | §七、§十、§十三 | 一致 |
| finalityN=12、checkpoint(blockNumber,logIndex) | §5 五 Finality 与 reorg | §七、§十 参考实例、§十三 | 一致 |
| 可接单条件 | §4、§10：registry.approved && !suspended && now<expiry && staking>=minStake(tier) | §四 导游状态机；§十 Registry 行 | 一致 |
| 档期：Accepted 占档、Created 软占 TTL | §5 十一 档期（P0） | §三 订单与托管；§四 | 一致 |
| 12 缝、8 项 RBAC | §10 12 缝表、8 项表 | §九、§十三 | 一致 |
| 17 条验收、资损 runbook 5 条 | §10 审计验收表、审计前检查清单、发布与 E2E | §十一、§十二、§十三 | 一致 |
| 执行器：多签/时间锁、resolutionId 幂等、双人审批 | §7 权限与角色、执行器 P0 | §六 权限与边界；§七；§十三 | 一致 |
| 仓库骨架 core/api/web/chain-client/contracts | §8 总库总览 | §二 对应到仓库 | 一致 |
| Web 与 DApp 业务数据同源（行程、接待人、订单） | §9 数据流与职责、05/06 | §八 数据流（同源说明） | 一致 |

---

## 二、整体分层

```
┌─────────────────────────────────────────────────────────────────────────┐
│  表现层 (Presentation)                                                   │
│  游客端 / 导游端 / 仲裁后台 / 开放 API                                    │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
┌─────────────────────────────────▼───────────────────────────────────────┐
│  应用层 (Application)                                                     │
│  用例：下单、确认完成、发起争议、裁决、质押、评价                          │
│  只编排领域与基础设施，不写业务规则                                        │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
┌─────────────────────────────────▼───────────────────────────────────────┐
│  领域层 (Domain)                                                          │
│  订单状态机、托管规则、评分权重、仲裁规则、质押门槛                        │
│  纯业务逻辑，不依赖 DB/HTTP/链                                            │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
┌─────────────────────────────────▼───────────────────────────────────────┐
│  基础设施层 (Infrastructure)                                              │
│  数据库、链客户端（含支付/托管）、KYC、通知、存储                          │
│  通过接口被领域/应用层依赖，可替换                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

- **表现层**：协议与 UI 适配（HTTP、WebSocket、Yew 前端）。
- **应用层**：用例入口（handler），编排领域 + 基础设施，不写核心业务规则。
- **领域层**：状态机、规则、计算（如权重），可单测，无外部依赖。
- **基础设施层**：DB、链客户端（含支付/托管）、KYC、通知、存储；用 trait/接口抽象，便于换实现。

**对应到仓库**：

| 层/部署 | 仓库路径 | 说明 |
|---------|----------|------|
| 表现层 | `crates/web` | DApp 模式、钱包与签名 |
| 应用层+基础设施 | `crates/api`（含 `api/chain`） | 用例编排、链客户端调用 |
| 领域层 | `crates/core` | 纯业务逻辑 |
| 链客户端（可选） | `crates/chain-client` | EVM alloy，被 api 依赖 |
| 链上部署 | `contracts/` | Escrow/Staking/Registry（Solidity） |

**技术形态（混合）**：链上 Escrow/Staking/Registry（方案 B）为资金与准入真相；链下 DB 做业务与检索、对账同步链上事件。协议定位为去中心化，与 01 一致。

**依赖原则**：依赖单向向下（表现→应用→领域→基础设施）；领域层不依赖表现层、应用层或基础设施的具体实现（仅依赖接口/trait），避免循环依赖与便于单测。

**Rust 实现约定（最佳实践）**：  
- **trait 定义**：领域层定义「端口」trait（如 `EscrowLedger`、`StakingStore`），由 `api` 或 `chain-client` 实现；trait 定义可放在 `core`（领域驱动）或独立 `ports` 模块，实现不注入 core，便于 core 单测用 mock。  
- **core 无 I/O**：`crates/core` 不依赖 `std::net`、`tokio`、`sqlx`、`alloy` 等；仅用 `std` 与业务类型，保证领域逻辑可纯单测、无异步与网络依赖。  
- **错误类型**：跨层用 `Result<T, E>`；`E` 建议枚举或 `thiserror` 派生，应用层可映射为 HTTP/业务错误；领域层返回领域错误（如非法状态迁移），由应用层决定是否重试/告警。  
- **async 边界**：应用层（Axum handler、队列消费、执行器）为 async；领域层方法建议 **sync**，由应用层在 async 块中调用，避免领域逻辑被 async 污染、便于单测。链调用与 DB 在基础设施层 async，通过 trait 暴露。  
- **与 01 骨架一致**：Yew 前端、Axum 后端、SQLx/trait 持久化、alloy 链客户端；见 01 仓库骨架与 04。

---

## 三、领域切分（Bounded Context）

| 子域 | 职责 | 核心概念 |
|------|------|----------|
| **身份与访问** | 注册、登录、角色、KYC | User, Role, KycStatus |
| **导游市场 (Registry + Staking)** | 导游资料、质押申请身份、上下架、可接单条件 | Guide, Stake, StakeTier, Registry.approved |
| **订单与托管 (Escrow)** | 下单、锁定、完成、取消、争议入口；**档期**（Accepted 占档、Created 软占 TTL） | Order, OrderState, Escrow, Slot |
| **支付** | 扣款、锁定、放款、退款（抽象为端口，MVP 实现为链上 Escrow+USDC） | Payment, Lock, Release |
| **信誉 (Reputation)** | 评价、权重、聚合分 | Review, ReviewWeight, Score |
| **争议 (Dispute)** | 举证、仲裁、裁决、执行 | Dispute, Evidence, Resolution |

依赖建议：身份被各子域用；订单/托管依赖支付、导游市场；信誉只依赖已完成订单；争议依赖订单，执行时调支付/质押。

**子域与仓库映射**（实现参考）：

| 子域 | 领域逻辑 | 应用/基础设施 |
|------|----------|----------------|
| 身份与访问 | `core/identity` | api/routes（认证）、api/db（用户表） |
| 导游市场 | `core/registry`、`core/staking` | api/chain（Registry/Staking 合约）、contracts/registry、contracts/staking |
| 订单与托管 | `core/escrow` | api/chain（Escrow）、api/db（订单/档期）、contracts/escrow |
| 支付 | `core` 内与 Escrow 一体 | api/chain（链上支付）、事件驱动投影 |
| 信誉 | `core/reputation` | api/db（reviews）、Phase2 可选 contracts/reputation |
| 争议 | `core` 争议规则 | api/db（disputes、证据）、执行器调 api/chain |

代码上 `core` 按模块分 `identity`、`registry`、`escrow`、`reputation`、`dispute`；与 01 仓库骨架一致。

---

## 四、状态机（显式、可审计）

与 [01-总库总览](01-总库总览.md) 订单状态机一致，此处为架构层摘要。

- **订单**：`Created → Accepted → Escrowed → Completed | Disputed | Cancelled`；**Disputed** 裁决后必落资金终态之一：`Refunded | PartiallyRefunded | Slashed | Completed`。  
  - 仅 **Escrowed** 可进 `Completed` 或 `Disputed`；仅资金终态订单可触发评价。终态与合法迁移见 01。
- **争议**：`Open → Assigned → Resolved`  
  - 裁决字段明确（如 `refund_ratio`、`slash_guide`），由**执行器**链上执行放款/扣罚；结果仅由链上事件驱动 DB。
- **导游**：`Pending → Active | Suspended`  
  - 满足质押 + Registry 审核（方案 B）→ Active；违规或仲裁 → Suspended。可接单条件见 01：`registry.approved && now<expiry && staking>=minStake(tier) && !suspended`。

实现：领域层用枚举 + 方法（如 `order.can_transition_to(Completed)`）；**DB 状态仅由链上事件（finalityN 后）驱动**，存事件与投影便于审计与对账。

**主流程串联（业务逻辑畅通性）**：  
- 下单 → **Created**；接单 → **Accepted**（占档）。**双方确认后才上链**：Created/Accepted 链下或 EIP-712 签名，**资金上链仅在 deposit 后** → **Escrowed**。  
- 行程结束后：双签或单方超时 → **Completed**；任一方发起争议 → **Disputed**。Disputed 后仲裁员裁决，**执行器**代发 executeResolution → **Refunded | PartiallyRefunded | Slashed | Completed** 之一。  
- 取消/超时（Created 或 Accepted）→ **Cancelled**。资金状态仅由链上事件驱动，应用层与 Indexer 按上述顺序编排与投影，与 01 一致。

**状态×可执行操作×执行者（逻辑边界）**：

| 订单状态 | 可执行操作 | 执行者 | 备注 |
|----------|------------|--------|------|
| Created | 接单、取消 | 导游、任一方、超时 | Accepted 占档；取消/超时→Cancelled |
| Accepted | 支付进 Escrow、取消 | 游客（钱包签）、任一方、超时 | 仅 deposit()→Paid 驱动 Escrowed |
| Escrowed | 双签完成、发起争议、refundIfNotStarted（若未满足服务证据） | 导游+游客、任一方、游客/导游（自救） | 双签或超时→Completed；争议→Disputed |
| Disputed | 裁决（链下）→执行器上链 | 仲裁员→执行器 | 裁决后必落资金终态之一 |
| 资金终态 | 评价 | 游客/导游 | 仅资金终态可评价（01 Sybil P0） |

领域层需实现：在给定状态下仅允许上述操作之一，且迁移合法（如 `can_transition_to`）；应用层校验角色与签名后再调领域与链。

---

## 五、钱和链：抽象成端口

与 01「链为准」一致：**资金与托管以链上为准**，DB 为缓存与对账投影。

- **支付与托管**：抽象为「锁定」「放款」「退款」「扣罚」等操作；**MVP 实现为链上**（Escrow 合约 + USDC），基础设施层通过链客户端（trait）接入，便于单测 mock、多 RPC 与退避。
- **链**：Staking、Escrow、Registry 用 trait（如 `StakingStore`、`EscrowLedger`、`RegistryReader`）；**生产实现为链上合约**（方案 B），见 01 链与代币选型。Reputation 可选 Phase2 上链。

领域层只关心「是否锁定/放款成功」及事件结果；**状态仅由链上事件驱动**，换 RPC 或测试环境只换实现，不改领域逻辑。

---

## 六、安全与合规在架构中的位置

- **认证/鉴权**：表现层或应用层入口（中间件取当前用户），领域层只接收 `user_id`/`role`。与 01 主身份、RBAC 一致。
- **KYC/AML**：身份子域 + 基础设施（调第三方）；领域层只判断 `KycStatus`；链上不存 PII。
- **证据与隐私**：证据原件在基础设施层（对象存储 + pre-signed URL）；链上仅 hash/schemaVersion；PII 加密/KMS、访问审计。与 01 证据可用性 P0-3、隐私 P0-4 一致。
- **审计**：下单、放款、裁决、扣罚等写审计日志（谁、何时、状态与金额）；对账三段式在应用层或独立任务执行，见 01。
- **幂等**：API（requestId/idempotency-key）、队列消费、执行器（resolutionId）、用户连点（orderId+action）各有幂等键，见 01。
- **限流与防滥用**：表现层或应用层入口（rate limit、黑名单、证据大小/类型白名单）；与 01 反刷/限流 P0、证据 DoS P0 一致。领域层不实现限流，仅接收「是否允许」结果。

**权限与边界（汇总）**：  

| 边界 | 谁可执行 | 说明 |
|------|----------|------|
| **链上·用户签** | 游客、导游（各自钱包） | deposit、confirm 完成、openDispute 等由前端发起、用户签名；后端不代签、不持私钥（01 代付 P0）。 |
| **链上·执行器代发** | 执行器（多签/时间锁） | 仅 executeResolution（裁决后放款/退款/扣罚）；单笔/单日额度、双人审批、resolutionId 幂等；执行器不裁决议题，只执行已审批的 resolutionType 与 amounts。 |
| **链上·治理** | 多签/运营 | Registry approve、pause、allowlist 变更等；阈值+timelock 见 01。 |
| **DB·写** | 应用层、对账任务、Indexer 投影 | 资金相关状态**仅由事件投影/对账**写入，禁止因「前端成功」或代付成功直写 Paid；人工修复只写 correction 表。 |
| **裁决** | 仅仲裁员（类型写死） | 裁决结果含工单号、签名含 arbiterRoleSnapshotHash 或 arbiterAuthVersion；裁决后由执行器上链，仲裁员不直接调链。 |
| **子域边界** | 订单不直接改 Staking；争议不直接改 Escrow 余额 | 争议子域通过「执行器 + 链上 executeResolution」间接完成资金终态；领域层仅表达规则与校验，不跨子域写链。 |

与 01 权限与角色、8 项 RBAC、执行器 P0 一致；RBAC 定稿见 01 与 04。

---

## 七、事件消费、对账与执行器在架构中的位置

与 [01-总库总览](01-总库总览.md) 链为准、对账、发布与 E2E 一致。

- **事件消费（Indexer）**：拉取链上四类事件（EscrowCreated/Paid/DisputeOpened/ResolutionExecuted），经 **finalityN** 确认后写**事件表**（blockNumber、blockHash、txHash、logIndex）；**投影**驱动更新 DB 订单/资金状态。**checkpoint**=(blockNumber,logIndex)；reorg 时回退并重放。领域层不直接读链，只消费已确认事件的投影。
- **对账**：应用层或独立定时任务，比对事件投影与 DB；差异按 01 **三段式**（自动修/半自动/人工）处理；链无 DB 有 Paid → 告警与冻结。规则与上限见 01。
- **执行器**：应用层组件（或独立服务），裁决后**代发**链上 executeResolution；多签/时间锁、单笔/单日额度、**resolutionId 幂等**、双人审批见 01。执行器只执行已审批的 resolutionType 与 amounts，不裁决议题。

---

## 八、数据流与职责（架构视角）

与 01 §9 数据流与职责一览对应，此处为架构层归纳。

| 角色/端 | 主要动作 | 经过的层/组件 |
|---------|----------|----------------|
| 游客 | 注册、下单、支付（钱包签）、确认/争议、评价 | 表现层(Web/DApp) → 应用层(API) → 领域层(订单/支付规则) → 基础设施(DB/链客户端) |
| 导游 | 注册、质押、接单、确认完成、争议 | 同上；质押/确认走钱包签，链上执行 |
| 仲裁员 | 登录、查看争议、裁决（链下） | 表现层(后台) → 应用层 → 领域层(争议规则) → DB；裁决上链由**执行器**代发 |
| 后端/系统 | 事件消费、对账、执行器代发、通知 | 基础设施(Indexer) → 事件表 → 投影更新；对账任务；执行器调链客户端 |

**Web 与 DApp 业务数据同源**：旅行行程、接待人员（导游）信息、订单详情、档期等业务数据**唯一来自应用层 API/DB**；Web 页与 DApp 页共用同一 API，展示一致。链上仅资金与托管状态。见 01 §9、[05-前端总览](05-前端总览.md)、[06-DApp架构总览](06-DApp架构总览.md)。

---

## 九、架构决策点与 01 的衔接

以下在 01 中列为「必须写死」的**12 缝**与**8 项 RBAC**，在架构上属于**架构级决策点**：在分层与子域确定后，这些选项的选定会影响领域层规则、基础设施层实现与合约设计。具体写死内容见 [01-总库总览](01-总库总览.md) 12 缝表与 8 项表。

- **12 缝**：topUp、dispute 多次、自动放款 vs DisputeWindow、executeResolution 绑定、resolutionSeq、Pause 白名单、allowedTokens remove、finalityN 修改、事件 checkpoint、证据时间戳、钱包解绑/换绑、取消/No-show 矩阵。
- **8 项 RBAC**：主身份、工厂 onchain mapping、autoComplete 与 disputeWindow、服务开始证据最小集合、仲裁费政策、token 异常承诺、executeResolution 分级白名单、DB 全丢重建最小产物。

架构设计阶段需与 01 对齐上述决策，避免实现时返工；实现时以 01 表为准逐项落配置与校验。

**架构阶段验收（企业级）**：开工前确认两点——（1）01 中 12 缝表与 8 项表均有写死结论或选定，无「待定」；（2）17 条验收与系统级不变量与本文分层、边界、事件驱动一致。若有未定项，须在 01 定稿后再进入实现。

---

## 十、合约/逻辑模块对应（与实现方式）

与 [01-总库总览](01-总库总览.md) §4 智能合约、§5 链与代币选型一致。**实现状态**：本仓库内 `contracts/`（Escrow/Staking/Registry）**当前为设计态**— 合约代码待实现或位于独立 repo；定稿与部署前须与 01/02/08-4、Runbook §7/§10 对齐，不可逆结构图证明可先以设计图落 evidence，见 [08-0 §十](08-0-系列审计-命名排序与合并瘦身.md)。

| 模块 | MVP | Phase2 或可选 |
|------|-----|----------------|
| **Registry** | **链上**（方案 B：多签/运营 approve，可撤销、过期） | — |
| **Escrow** | **链上**（EscrowFactory + 每单 clone EIP-1167，USDC） | — |
| **Staking** | **链上**（质押/扣罚/解押，与 Registry 配合可接单） | — |
| **Reputation** | DB 表 `reviews` + 权重计算 | 评分哈希上链 |
| **Dispute 执行** | DB 表 `disputes` + 仲裁员分配；裁决由**执行器**链上执行 | 可选链上执行入口 |

DB 存订单/导游/证据等业务数据，**仅作缓存与检索**；Paid/Released/Refunded/Slashed 等资金状态以链上事件为准、对账同步。**链上事件**：EscrowCreated/Paid/DisputeOpened/ResolutionExecuted 为状态驱动与对账锚点，事件表与投影仅据此更新，见 01 §5 四。后端路由、数据模型、风控见 [04-后端与API](04-后端与API.md)。

**功能与参考实例对照**（实现时可对照业界模式，避免重复踩坑）：

| 功能 | 参考实例/模式 | 本架构采用要点 |
|------|----------------|----------------|
| **Escrow** | OpenZeppelin Escrow/RefundEscrow；Gnosis Safe 条件释放；**旅行/预订**：Airbnb 支付托管至入住后 24h 释放或争议 | Factory + 每单 clone（EIP-1167）；单币单笔；仅 deposit()→Paid；release/refund/executeResolution 三者之一终态；effects-before-interactions + nonReentrant |
| **Staking** | OpenZeppelin 质押/锁仓模式；PoS 类 slash 与解押冷却（如 Lido 简化版） | 币锁在 Staking 合约；minStake(tier)；争议裁决可扣罚；解押冷却期 7–30 天；冻结期间不可 withdraw（01 写死） |
| **Registry** | 链上准入/资格：AccessControl、EIP-5484 attestation、Soulbound 类注册表 | 方案 B：链下 KYC + 链上 approve(guide, tier, expiry)；可撤销、可过期；可接单 = approved && stake≥min && !suspended |
| **争议与执行** | **人工裁决 + 链上执行**：部分保险/赔付系统；Kleros 为纯链上仲裁、UMA 为预言机争议，本方案为混合 | 证据链下、裁决链下；执行器多签/时间锁代发 executeResolution；resolutionId 幂等、双人审批、额度上限 |
| **事件与索引** | The Graph / Envio 子图；自建：ethers/alloy getLogs + finality 确认 | finalityN=12；checkpoint(blockNumber,logIndex)；reorg 回退重放；事件表 append-only，投影可重建（01 §5 五、17 条） |
| **预订流程** | **旅行**：Booking.com 预付款/到店付；Airbnb 预订→确认→支付托管→入住后释放 | 双方确认后才上链；Created→Accepted（链下/签名）→Escrowed（deposit）→Completed/Disputed；超时与争议窗口见 01/03 |

---

## 十一、架构原则小结

| # | 原则 | 01 对应 |
|---|------|--------|
| 1 | **分层清晰**：表现→应用→领域→基础设施，依赖单向向下；chain-client、contracts 归属明确 | 01 §8 骨架、01 §9 数据流 |
| 2 | **领域按子域切**：身份、Registry+Staking、Escrow（含档期）、支付、Reputation、Dispute 各管一块 | 01 §4 合约、01 §8 骨架 |
| 3 | **状态机显式、可审计**：订单/争议/导游用枚举+规则；**DB 状态仅由链上事件驱动** | 01 §1 状态机、01 §3 链 vs DB、01 §5 事件 |
| 4 | **钱和链**：链为准、链抽象为端口；MVP 支付与托管为链上实现 | 01 §3 链 vs DB、01 §5 链与代币 |
| 5 | **事件与对账**：Indexer→事件表→投影；对账与执行器为应用层/独立组件 | 01 §9 对账、发布与 E2E、资损 runbook |
| 6 | **合规与安全**：认证在入口，KYC/证据/隐私/审计在身份与基础设施；幂等落点明确 | 01 §6 证据与隐私、01 §7 权限、17 条验收 |
| 7 | **架构决策点**：12 缝与 8 项 RBAC 在架构阶段与 01 定稿 | 01 §10 小结、12 缝表、8 项表 |
| 8 | **非功能与运维**：可观测、韧性、对账、限流、部署与测试见 §十二 | 01 §9 对账/SLO、资损 runbook、17 条 |
| 9 | **Rust 与业务边界**：§二 trait/core/async 约定；§四 主流程与状态×操作×执行者表；§六 权限与边界表 | 01 §8 骨架、01 §7 权限与执行器 P0 |
| 10 | **参考实例与检查清单**：§十 功能与参考实例对照；§十三 安全·流程·审计检查清单；与 01 17 条/12 缝/资损 runbook 衔接 | 01 §10 小结、审计验收与检查清单 |
| 11 | **Web 与 DApp 业务数据同源**：行程、接待人、订单等唯一来自 API/DB；Web 与 DApp 页共用同一 API，见 §八、01 §9、[05](05-前端总览.md)、[06](06-DApp架构总览.md) | 01 §9 数据流、[05](05-前端总览.md)、[06](06-DApp架构总览.md) |

---

## 十二、非功能与运维（企业级要求）

与 [01-总库总览](01-总库总览.md) 对账、SLO、资损 runbook、发布与 E2E 衔接；落地细节见 04/07。

| 维度 | 架构层要求 | 说明 |
|------|------------|------|
| **可观测性** | 日志、指标、链路追踪在应用层与基础设施层落点 | traceId 贯通 requestId→messageId→txHash→logIndex（01）；关键操作（下单、支付、裁决、执行器）打点；便于审计导出与资损排查。 |
| **韧性** | 链客户端多 RPC、退避与重试；事件消费 checkpoint、reorg 重放；执行失败→队列+重试 | 与 01 双写→链为准+对账+幂等、RPC 多 endpoint+退避一致。**资损 runbook（P0）至少 5 条**：① RPC 大面积不可用；② Indexer 落后；③ reorg 触发撤销；④ 执行器卡单；⑤ token 冻结/黑名单导致结算失败。详见 01 §9 发布与 E2E。 |
| **可用性与对账** | 对账三段式（自动修/半自动/人工）；链无 DB 有 Paid 等异常→告警与冻结 | 01 SLO P0-7、对账触发条件与上限；事件表 append-only，投影可重建，支撑 DB 全丢重建（01 P0-6）。 |
| **限流与防滥用** | 见 §六（表现层或应用层入口） | rate limit、证据 DoS 防护、黑名单；与 01 反刷/限流 P0、证据 DoS P0 一致。 |
| **部署与发布** | 合约工厂版本、灰度与回滚策略；老工厂 pause 不影响存量订单 | 01：pause 老 factory 不影响存量、ABI 只增不改、灰度与回滚写死；manifest 含字节码/配置/checkpoint/E2E。 |
| **测试策略** | 领域层单测（状态机、规则）；集成测（api + 链 mock/测试网）；E2E 与 17 条验收见 01/07 | 领域层无外部依赖，可纯单测；链与对账逻辑需集成与 E2E 覆盖，见 [07-开发流程与顺序](07-开发流程与顺序.md)。 |

---

## 十三、架构级检查清单（安全·流程·审计）

实现与审计前可按下表逐项确认；具体 P0/17 条/12 缝以 [01-总库总览](01-总库总览.md) 为准，此处为架构层归纳。

### 13.1 安全

| 类别 | 检查项 | 架构落点 | 01/合约对应 |
|------|--------|----------|-------------|
| **重入与调用顺序** | 合约 effects-before-interactions；非重入锁 | Escrow release/refund/executeResolution 先改状态再 transfer | 01 §5 十一；仅 ERC20、拒 ERC777 |
| **权限与最小特权** | 谁可调哪些链上方法；执行器仅执行不裁决 | §六 权限与边界表；用户签 vs 执行器代发 vs 治理 | 01 §7 权限、8 项 RBAC |
| **签名与重放** | EIP-712 domainSeparator 固定；nonce/expiry 防重放 | Created/Accepted/confirm 签名的 nonce 单调、含 chainId/orderId | 01 §5 十一 双签与防护 |
| **前端/代付** | 后端不持私钥、不代签；代付需法务门禁 | 表现层钱包签；§六 链上·用户签 | 01 代付 P0、UI 事实 P0 |
| **资金边界** | DB 不因「前端成功」写 Paid；仅事件驱动 | §六 DB·写、§七 事件消费与投影 | 01 链为准、17 条 #2/#12 |
| **Token 与 Allowlist** | 仅 allowlist 内 token；移除后存量 safe-path | 合约 allowlist；治理 timelock≥48h | 01 §5 九、12 缝 #7 |
| **Pause 与自救** | Pause 后仅允许自救型操作；白名单写死 | 工厂/合约 Pause 白名单（refundIfNotStarted 等） | 01 §7 Pause 后、12 缝 #6 |
| **证据与隐私** | 链上不存 PII；证据大小/类型白名单、DoS 防护 | 基础设施层存储与 pre-signed URL；§六 限流 | 01 证据 DoS P0、隐私 P0-4 |

### 13.2 流程

| 类别 | 检查项 | 架构落点 | 01/03 对应 |
|------|--------|----------|------------|
| **状态机完备** | 每状态合法下一状态写死；无悬空迁移 | §四 订单/争议/导游状态机；状态×操作×执行者表 | 01 §1 状态机、03 对照表 |
| **资金终态唯一** | 每单仅能进入一次资金终态；Disputed 必落四类之一 | 合约状态锁；执行器 resolutionId 幂等 | 01 系统级不变量、17 条 |
| **超时与窗口** | 接单/支付/完成超时；disputeDeadline≥autoCompleteAt | 领域层规则 + 合约/配置；03 时间节点 | 01 §5 十 争议窗口、12 缝 #3 |
| **幂等** | API/队列/执行器/连点各有幂等键 | §六 幂等、§七 执行器 resolutionId | 01 幂等与键 P0、17 条 #14 |
| **事件与投影** | 仅 finalityN 后事件驱动 DB；checkpoint 含 logIndex | §七 Indexer、事件表、投影 | 01 §5 四/五、17 条 #12/#13 |
| **对账** | 三段式（自动/半自动/人工）；链无 DB 有→告警与冻结 | §七 对账、§十二 可用性与对账 | 01 §9 对账、17 条 #15 |
| **副作用与回放** | 状态迁移触发的占档/通知等写死；回放不重复/错发 | 领域层副作用列表；Indexer 投影与补偿 | 01 状态机与副作用 P0、17 条 #16 |

### 13.3 审计与可追溯

| 类别 | 检查项 | 架构落点 | 01 对应 |
|------|--------|----------|--------|
| **事件锚点** | EscrowCreated/Paid/DisputeOpened/ResolutionExecuted 为唯一资金状态来源 | §七 事件消费、§十 链上事件 | 01 §5 四、17 条 #2/#6/#12 |
| **traceId 贯通** | requestId→messageId→txHash→logIndex 可串查 | §十二 可观测性 | 01 发布与 E2E、manifest |
| **裁决与执行可验证** | 裁决含工单号、签名含 arbiterRoleSnapshotHash；执行器审计表 | §六 裁决边界、执行器代发 | 01 §7 仲裁员 P0、17 条 #11 |
| **DB 全丢重建** | 仅靠事件可重建最小产物；重建脚本/CI | 事件表 + 投影逻辑；§十二 可用性 | 01 P0-6、8 项 #8、17 条 #6 |
| **资损 runbook** | 至少 5 条：① RPC 大面积不可用 ② Indexer 落后 ③ reorg 触发撤销 ④ 执行器卡单 ⑤ token 冻结/黑名单 | §十二 韧性、可用性 | 01 §9 发布与 E2E |
| **12 缝与 8 项** | 每条有写死结论；无「待定」 | §九 架构决策点 | 01 §10 12 缝表、8 项表 |
| **17 条验收** | 每条对应单测/E2E/对账脚本或 runbook，可产出证据产物 | 分层与边界与本文一致；实现落在 04/07 | 01 §10 审计验收表、审计前检查清单 |

**使用方式**：开工前与发版前各做一次勾选；建议顺序 **13.1 安全 → 13.2 流程 → 13.3 审计**。建议将本清单导出为工单或 checklist，逐项勾选并留存证据。任一项不满足时，须在 01/03/04 或合约中定稿后再通过。架构变更须同步更新本清单与 01 相关节。

**审计结论**：本文已通过与 01 可追溯性、§十三 与 [07-开发流程与顺序](07-开发流程与顺序.md) 开工前/发版前勾选衔接等企业级检查；检查日期与文档版本见 [00-文档索引](00-文档索引.md)。

---

*本文与 [01-总库总览](01-总库总览.md)、[03-业务流程与风控](03-业务流程与风控.md)、[04-后端与API](04-后端与API.md)、[05-前端总览](05-前端总览.md)、[06-DApp架构总览](06-DApp架构总览.md)、[07-开发流程与顺序](07-开发流程与顺序.md) 配套。文档版本与最后更新见 [00-文档索引](00-文档索引.md)。*
