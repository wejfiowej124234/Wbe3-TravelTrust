# 开发流程与顺序（企业级）

本文按**企业级项目**要求，明确：**第一件事要先确认的架构**、**开发阶段与顺序**。文档阅读顺序与实现顺序一致，见 [00-文档索引](00-文档索引.md)。P0/12 缝/17 条/系统级不变量以 [01-总库总览](01-总库总览.md) 为准；[02-架构设计](02-架构设计.md) 负责分层与 12 缝/8 项/17 条可追溯。

**受众与用法**：架构、开发与项目管理；实现时与 01～06 配合，Phase 与 06 Phase 3/4、04 §五 落地顺序一致。**文档维护责任**：技术或项目负责人；阶段或检查点变更须同步 01/02/03 及 04/05/06。01 §9/§10 变更时建议 01 维护者同步本文；04 §五 落地顺序变更时建议 04 维护者同步本文 §三。文档版本与最后更新见 [00-文档索引](00-文档索引.md)。

**内容与结构**：§一 先确认的架构与决策 · §二 开发阶段与顺序 · §三 文档与实现顺序对照 · **§四 企业级审计标注**（4.1 与 01～06 一致性核对、4.2 审计报告与多维度结论、4.3 开工前/发版前检查清单）。

---

## 一、第一件事：先确认的架构与决策

在写业务代码或合约之前，以下**架构与决策必须先行确认**，并达成团队/干系人一致。

### 1.1 必须确认的架构

| 序号 | 确认项 | 说明 | 对应文档 |
|------|--------|------|----------|
| 1 | **业务与数据形态** | **去中心化协议**；链上托管/质押/**Registry（资格）**/信誉存证，链下 DB 做业务与检索；导游准入**方案 B**（链上质押+链下审核+链上发资格）；链选型已确定为 **EVM（以太坊 + L2）**。 | [01-总库总览](01-总库总览.md) |
| 2 | **分层与边界** | 表现层（Yew）、应用层（API handlers）、领域层（core）、基础设施层（DB/链）；依赖单向向下，领域不依赖具体实现。 | [02-架构设计](02-架构设计.md) |
| 3 | **子域划分** | 身份、Registry、Escrow、支付、Reputation、Dispute 各子域职责与依赖；core 模块与 DB 表归属。 | [02-架构设计](02-架构设计.md) |
| 4 | **状态机** | 订单、争议、导游的**显式状态**与合法流转；终态定义；超时与自动推进规则。 | [02-架构设计](02-架构设计.md)、[03-业务流程与风控](03-业务流程与风控.md) |
| 5 | **业务流程与规则** | 接单/支付/完成超时、取消与退款阶梯、评分规则与防恶意、争议由人工裁决后合约执行。 | [03-业务流程与风控](03-业务流程与风控.md) |
| 6 | **链与合约边界** | EVM + Solidity；Escrow/Staking/**Registry（方案 B：链上质押+链下审核+链上发资格）**必须上链；代币白名单（稳定币）；合约与后端/前端的交互方式（谁调合约、谁读状态）。 | [01-总库总览](01-总库总览.md)、[06-DApp架构总览](06-DApp架构总览.md) |
| 7 | **钱包与 DApp 模式** | 不自研钱包，兼容市场钱包；DApp 与普通 Web 共用同一前端；签名前展示、EIP-712 等安全约定；代付默认不托管、代付 PR 触发法务门禁（01 §7）；前端/代付与资金边界见 02 §十三 13.1。 | [01-总库总览](01-总库总览.md)、[02-架构设计](02-架构设计.md)、[06-DApp架构总览](06-DApp架构总览.md) |

### 1.2 确认方式建议

用 01、02、03 做「架构与业务规则」评审，输出状态机表、接口清单（API+合约）、异常与超时规则；上述确认项变更须走变更流程，避免开发中随意改架构导致返工。

---

## 二、开发阶段与顺序

按**依赖关系**与**风险前置**原则，建议以下顺序；每阶段完成后再进入下一阶段，避免并行改同一块导致不一致。

| 阶段 | 内容 | 产出 | 参考文档 |
|------|------|------|----------|
| **Phase 0：架构与规则锁定** | 确认 1.1 中全部项；确定 MVP 范围（如先单链、先链下再上链）；与 [01-总库总览](01-总库总览.md) §10 **审计前检查清单**对齐：**12 缝**每条有写死结论、**17 条**每条可追溯单测/E2E/runbook、**资损 runbook** 至少 5 条范围确定、**系统级不变量**与设计无冲突。**P0 门禁清单**：发版前须过 [08-战略与合规风险检查清单](08-1-战略与合规风险检查清单.md)（见 §4.3）。 | 架构评审结论、状态机与 API/合约接口清单；12 缝/17 条可追溯表。 | 01、02、03、08 |
| **Phase 1：领域与后端骨架** | core 类型与状态机实现；api 项目骨架、DB 选型与表结构、基础路由（健康检查、占位）；**无链、无前端**。 | 可运行的 API（占位路由）、DB 迁移脚本、core 单元测试。 | 02、[04-后端与API](04-后端与API.md) |
| **Phase 2：核心业务流程（链下）** | 用户/导游 CRUD、订单状态机（创建→接单→支付占位→完成）、评价与权重计算、争议表与人工裁决流程（仅 DB）；支付与链用 mock；**超时与争议窗口**与 01/03 定稿一致（含 disputeDeadline≥autoCompleteAt）。 | 完整订单与争议链下闭环、API 可被前端或 Postman 调用。 | 03、04 |
| **Phase 3：智能合约与链上对接** | Solidity **Escrow/Staking/Registry（方案 B）** 开发与测试网部署（01 §4 必须上链）；后端 chain 模块（alloy）读链状态、提交交易；支付/质押/放款与链打通；**争议裁决后执行器代发上链**（executeResolution）与 01 §7 执行器 P0 一致。 | 测试网可完成「支付→放款」闭环；链与 DB 状态同步策略确定。 | 01、06、contracts |
| **Phase 4：前端与 DApp** | Yew 前端：页面骨架、API 调用、钱包连接与签名、支付/质押/确认完成/**发起争议（openDispute）**等流程（01 §7 须钱包签）；普通 Web 与 DApp 模式可切换。**须保证 Web 与 DApp 业务数据同源**（业务数据唯一来源为 04 API，行程、接待人、订单共用同一 API），见 01 §9、[04-后端与API](04-后端与API.md)、05、06；**05 §九 9.0.5** 敏感操作（签名前展示金额/代币/合约/订单、可取消拒绝）须满足；DApp 开工前须过 **06 §6.3 开工前检查清单**。 | 端到端：选导游→下单→支付（钱包）→完成→评价；含确认完成、openDispute 等钱包签（06 §6.3）；Web 与 DApp 页展示一致。 | 04、[05-前端总览](05-前端总览.md)、06 |
| **Phase 5：风控与运营就绪** | 评分防刷与异常检测、争议仲裁后台、KYC 预留、审计日志、监控与告警；合规与运营文档。 | 可上线试运行、争议可人工处理、关键操作可审计。 | 03、04、05 |

### 2.1 顺序约束（简要）

- **Phase 0 必须最先**：架构与规则未定不写业务代码；开工前建议过 [02-架构设计](02-架构设计.md) §十三 13.1 安全项勾选。
- **Phase 1 → 2**：无领域与 API 骨架，无法做完整业务流程。
- **Phase 2 可部分与 3 重叠**：链下闭环先跑通，再接真实链；但「链与 DB 一致性」需在 3 中定稿。
- **Phase 4 依赖 2 或 3**：前端依赖 API 与（若 DApp）链上能力。
- **Phase 5 可与 4 收尾并行**：风控与运营在功能基本齐全后补全。
- **发布前**：**必须**完成 [01-总库总览](01-总库总览.md) 中「发布与 E2E（P2）」所列 E2E 三项（**正常放款**、**争议三终态**、**三条超时路径**），否则不得视为可发布；**资损 runbook（P0）至少 5 条**（RPC/Indexer/reorg/执行器卡单/token 冻结）须已落文档，见 01 §9；发版前须过 [02-架构设计](02-架构设计.md) §十三 架构级检查清单（13.1 安全 → 13.2 流程 → 13.3 审计）；**须过 [08-战略与合规风险检查清单](08-1-战略与合规风险检查清单.md) 作为 P0 门禁清单**（§4.3 发版前检查）。

---

## 三、文档与实现顺序对照

| 阅读/评审顺序 | 文档 | 对应开发阶段 |
|----------------|------|----------------|
| 1 | [00-文档索引](00-文档索引.md) | 入口 |
| 2 | [01-总库总览](01-总库总览.md) | Phase 0（架构确认） |
| 3 | [02-架构设计](02-架构设计.md) | Phase 0、Phase 1 |
| 4 | [03-业务流程与风控](03-业务流程与风控.md) | Phase 0、Phase 2、Phase 5 |
| 5 | [04-后端与API](04-后端与API.md) | Phase 1、Phase 2、Phase 5 |
| 6 | [05-前端总览](05-前端总览.md) | Phase 4 |
| 7 | [06-DApp架构总览](06-DApp架构总览.md) | Phase 3、Phase 4 |
| 8 | [07-开发流程与顺序](07-开发流程与顺序.md)（本文） | 全程 |
| 9 | [08-1-战略与合规风险检查清单](08-1-战略与合规风险检查清单.md) 及 08 系列 | 发版前门禁、Phase 0 可选提前过 |

**与 04 §五 落地顺序对应**：04 §五 为**后端**落地顺序，Phase 1～4 与本文 Phase 1～4 有交叉对应（04 Phase 1≈本文 Phase 1；04 Phase 2≈本文 Phase 2 链下；04 Phase 3/4 的争议与链上/前端、支付+KYC 分别对应本文 Phase 3/4）。**完整阶段与顺序以本文 §二 为准**。

---

## 四、企业级审计标注

与 [01-总库总览](01-总库总览.md) §10 审计前检查清单及 02 §十三、04/05/06 审计标注衔接。

### 4.1 与 01～06 关键一致性核对

| 核对项 | 01/02/03/04/05/06 位置 | 07 落点 | 结论 |
|--------|------------------------|---------|------|
| E2E 三项、见 07 | 01 发布与 E2E（P2） | §2.1 发布前、4.3 发版前检查清单 | 一致 |
| 资损 runbook 至少 5 条 | 01 §9 发布与 E2E | §2.1 发布前、Phase 0 审计前检查清单对齐 | 一致 |
| 12 缝/17 条定稿、审计前检查清单 | 01 §10 | §1.1、Phase 0、4.3 | 一致 |
| Phase 3/4 须同时参 06、业务数据同源 Phase 4 | 06 开篇、6.3 | §二 Phase 3/4、Phase 4 同源与 06 §6.3 | 一致 |
| Phase 4/5 依赖 05、阶段衔接 | 05 §八、9.4 | §二 Phase 4/5、§三 表、4.3 | 一致 |
| 实现时与 07 配合、完整阶段见 07 §二§三 | 04 §五、02、03、05 受众 | 开篇受众、§二§三、4.3 | 一致 |
| 02 §十三 开工前与发版前各做一次勾选 | 02 §十三 使用方式 | §2.1 Phase 0 开工前 13.1、发布前 §十三 全项 | 一致 |
| 01 §9/§10 变更时维护闭环 | 01 文档维护责任已列 07/06 建议同步；07 依赖 01 §9/§10 | 07 开篇文档维护责任：01 §9/§10 变更时建议 01 维护者同步本文 | 一致 |
| 03 业务规则定稿前确认 | 03 §四：与 01 状态机/超时/争议窗口一致，开工前对照 01 §10、02 §十三 | Phase 0 的 1.1 第 4、5 项；4.3 开工前 1.1 七项+02 §十三 13.1 | 一致 |
| 04 §五 变更时维护闭环 | 04 §五 落地顺序与 07 §三 对应 | 07 开篇文档维护责任：04 §五 变更时建议 04 维护者同步本文 §三 | 一致 |

### 4.2 审计报告与多维度结论

**审计范围与依据**：07 全文与 01～06 可追溯性、§一 1.1 与 §二 Phase 0～5 及发布前门禁、§三 与 04 §五 对应、4.1 核对表与 4.3 检查清单；依据 01 §9/§10、02 §十三、03、04 §五、05 §八/9.4、06 开篇/6.3、00。

**逐项结果**：01～06 引用 07 或 Phase 均在 07 有落点（§2.1、§二§三、4.1、4.3）；Phase 0 含审计前检查清单四项，Phase 3 含 Registry 与执行器代发，Phase 4 含 openDispute 与 06 §6.3，发布前含 E2E 三项+资损 runbook+02 §十三 全项；03 业务规则定稿前确认由 Phase 0 与 4.3 覆盖；01/04 变更时维护闭环已载明 — **均通过**。

**多维度深度审计（12 维）**：可追溯性、与 01～06 一致性（含 02 §十三 全项、03 定稿、04 §五、05/06 Phase 4）、内部一致性、文档控制、检查清单可执行性、Phase 完整性、引用链接 — **均通过**。

**结论**：**通过**。07 可作为开发顺序与阶段衔接依据。变更后须同步 01/02/03 及 04/05/06 相关节并更新 4.1、4.3。

**瘦身后缺口检查**：§四 由原 4.1～4.4 合并为 4.1～4.3。01～06 引用 07 或 Phase 的落点均在 4.1 表、§二§三、4.3 中保留，无缺口。

**顶级企业级审计（本轮）**：  
**审计范围**：07 全文与 01/02/03/04/05/06/00 的可追溯性、1.1 七项与 01/02/03/06 对应、§二 Phase 0～5 与 01 发布与 E2E/资损 runbook/02 §十三 及 04/05/06 阶段引用、§三 与 04 §五 对应、4.1 核对表与 4.3 检查清单、文档维护责任与引用链接。  
**审计依据**：01（§9 发布与 E2E、§10 12 缝/17 条/审计前检查清单）、02 §十三、03 §四、04 §五、05 §八/9.4、06 开篇/6.3、00。  
**缺口检查**：01 引用 07（E2E、文档列表、骨架）→ §2.1、§三、4.1、4.3，无缺口。02 引用 07（§十三、E2E、17 条落在 04/07）→ §2.1、4.3，无缺口。03/04/05/06 引用 07 或 Phase → §二、§三、4.1、4.3 均有落点，无缺口。07 内部：1.1 表、Phase 表、2.1、§三 表与 04 对应、4.1 表、4.2 报告、4.3 表、文末 P0 枚举与配套链接一致，无矛盾。  
**结论**：**通过**。07 无未闭合缺口，与 01～06 全项可追溯，文档维护责任已明确 01/04 同步义务，可作为开发顺序与阶段衔接的权威依据。

**最高规格企业级审计（本轮）**  
**审计范围**：00～07 全文档。**维度**：文档控制（受众与用法、文档维护责任、版本见 00、内容与结构）、文末配套链接、维护闭环（01↔07/06、03↔04/05/06/07、04↔07、06↔07）、术语统一（争议三终态、12 缝/17 条）、权威链（01 P0/12 缝/17 条、02 §十三、04 §五↔07 §二§三、06 §6.3↔07 §4.3）、各文档企业级审计/检查清单节完备性。**已修复**：00 补受众与用法；01 补内容与结构（本文目录）、术语「争议三终态」与 07 统一；02 §十三 补审计结论。**建议**：03 §五 小节顺序可优化为 5.1→5.2→…→5.6→5.7（先维度与清单，后报告），便于读者按常规顺序阅读；当前 5.7 在前不影响结论正确性。**结论**：**通过**。00～07 满足最高规格企业级要求，无未闭合缺口。

**顶级文档审计（本轮）**  
**范围**：00～07 全文档。**检查项**：文档控制四要素（受众与用法、文档维护责任、版本见 00、内容与结构/本文目录）齐全；文末配套链接及版本声明一致；4.1/6.1 等表中「维护责任」与开篇「文档维护责任」用词统一；00 补文末配套与版本见上表声明。**已修复**：07 4.1 表两处「开篇维护责任」→「开篇文档维护责任」、01 列「文档维护责任已列」；06 6.1/6.2「维护责任」→「文档维护责任」；00 补文末「本文与 01～07 配套；文档版本与最后更新见上表」。**结论**：**通过**。无新增缺口，文档体系达顶级企业级文档审计要求。

### 4.3 开工前 / 发版前检查清单

| 时机 | 检查项 | 要求 |
|------|--------|------|
| **开工前**（Phase 0 完成前） | 1.1 七项、01 §10 审计前检查清单 | 全部确认并达成一致；12 缝/17 条/资损 runbook/系统级不变量对齐；建议勾选 02 §十三 13.1（前端/代付、资金边界）；可选提前过 08 清单中与架构相关项 |
| **发版前** | E2E 三项、资损 runbook、02 §十三、01 §10、**08 P0 门禁清单**、**08 附录 GO/NO-GO Gate** | 正常放款、争议三终态、三条超时路径必测；资损 runbook 至少 5 条已落文档；02 §十三 13.1→13.2→13.3 逐项勾选；12 缝无待定、17 条可产出证据、系统级不变量无冲突；**须过 [08-战略与合规风险检查清单](08-1-战略与合规风险检查清单.md)**（含 **5 条宪法级不变量** 逐条勾选）；**须过 08 附录 [上线 GO/NO-GO Gate](08-1-战略与合规风险检查清单.md#附录上线-go-no-go-gate发布级门禁)**（Gate-1～5 五门全过）；**须满足 08-2 一致性与冲突检测**（W-PDP-SSOT-CONSISTENCY、W-GATE-CROSS-CHECK：关键 key 与 08-4 同步、全 Gate 横向一致性评审）。**可验证发布**：每次发布须提供 manifest + hash + 可复现构建说明（08-4 第 7 章、08-2 W-Q6-FE）；前端构建产物与校验步骤见 05、08-1 Gate-5。**证据**：**首次**通过任一 Gate 时须产出至少一个 **evidence/GO_YYYYMMDD/**（含 manifest.json + manifest.sha256）并入仓；08-2 工单 Evidence 列须填**具体路径或 manifest.sha256**，不得仅占位。Runbook 定稿表 **P0 最小必填项**（见 08-2）须填满。**发版前快速核对**（逐项勾选）见 [00-文档索引 §08 系列](00-文档索引.md)「发版前快速核对」。 |

*CI 落地*：PR 改动 08-3 映射 key 时须同步 08-4 版本号，可接入 [08-5-CI与一致性落地说明](08-5-CI与一致性落地说明.md) 中的校验脚本或 workflow，未通过则阻断合并。

---

以上为企业级**先确认架构、再按阶段开发**的流程与顺序；具体 API 与表结构以 [04-后端与API](04-后端与API.md) 为准，业务规则以 [03-业务流程与风控](03-业务流程与风控.md) 为准；**P0/P1/P2 硬约束**（订单终态、Escrow 资金模型、Web 代付与仲裁执行器、信誉与导游准入、证据与隐私、可观测与 E2E）以 [01-总库总览](01-总库总览.md) 为准。

*本文与 [01-总库总览](01-总库总览.md)、[02-架构设计](02-架构设计.md)、[03-业务流程与风控](03-业务流程与风控.md)、[04-后端与API](04-后端与API.md)、[05-前端总览](05-前端总览.md)、[06-DApp架构总览](06-DApp架构总览.md)、[08-战略与合规风险检查清单](08-1-战略与合规风险检查清单.md) 配套。文档版本与最后更新见 [00-文档索引](00-文档索引.md)。*
