# DApp 架构总览（Yew 前端 · DApp 模式）

本文是 TravelTrust **DApp 侧**的架构总览：DApp 在**同一 Yew 前端**（crates/web）中的定位、与 Web 的架构关系、数据流与实现要点。与 [01-总库总览](01-总库总览.md)、[02-架构设计](02-架构设计.md)、[05-前端总览](05-前端总览.md) 配合阅读；DApp 为 05 中 **dapp/** 模块的架构展开，链与 DB 边界、用户签 vs 执行器代发以 01/02 为准。

**与 01/02/05 对应**：01 §7 钱包/代付/EIP-712、§5 链与代币 → 本文签名与合约交互；02 表现层与「链上·用户签」边界 → 本文 DApp 职责；裁决上链由执行器代发（01 执行器 P0）。05 为唯一前端总览，本文为其 **DApp 模式**专篇；业务数据以 [04-后端与API](04-后端与API.md) 为唯一来源；超时/争议见 01、[03-业务流程与风控](03-业务流程与风控.md)；阶段见 [07-开发流程与顺序](07-开发流程与顺序.md) Phase 3/4。**DApp 位置（已锁定）**：与普通 Web 共用同一 Yew 前端，通过「是否连接钱包」区分；一前端、Web+DApp 两模式、业务数据同源（05 §三）。

**受众与用法**：做**钱包/签名/支付/质押/争议**时 05 为主、06 为辅；仅做普通 Web 读 05+04 即可。受众：DApp 与钱包/链实现、前端与 05 对接人；建议先读 01、02、05；API 与规则以 04、01、03 为准。**与 08 门禁对应**：DApp/前端可替代性与可验证发布（08 Gate-5、W-Q6-FE/W-BOMB-10）见 [08-4 第 7 章](08-4-对外口径包.md)、[08-1 附录 Gate-5](08-1-战略与合规风险检查清单.md#附录上线-go-no-go-gate发布级门禁)；05 已含与 08 的落点说明。**文档维护责任**：前端或技术负责人；DApp 变更须与 01 §7/§10、02 §十三 13.1、05 一致并同步 04；§6.3 开工前检查清单变更时建议同步 [07-开发流程与顺序](07-开发流程与顺序.md) §4.3。文档版本与最后更新见 [00-文档索引](00-文档索引.md)。

**内容与结构**：§一 定位 · §二 整体架构（简图与业务数据同源）· §三 核心组成 · §四 典型数据流 · §五 技术要点与总库关系 · **§六 企业级审计**（维度与核对、审计报告、开工前检查清单）。

**06 与 01/02 关键一致性核对**（维护时以 01 为权威，06 不得与之冲突）：

| 核对项 | 01/02 位置 | 06 位置 | 结论 |
|--------|------------|---------|------|
| DApp/钱包/EIP-712/代付 P0、UI 事实 | 01 §7 | §一（含代付法务门禁、不托管）、§三、§四 数据流 1（UI 事实）、§五 安全（EIP-712） | 一致 |
| deposit/confirm/openDispute 须钱包签 | 01 §7 | §一、§三 签名与交易、§四 1～4 | 一致 |
| 12 缝 #11 钱包换绑与已支付订单 | 01 §10 | §四 钱包换绑与已支付订单 | 一致 |
| 17 条 #2 Paid 仅来自 deposit() | 01 §10 | §三、§四 数据流 1（须经 deposit，直转不算） | 一致 |
| 业务数据同源、04 为唯一来源 | 01 §9、04 开篇 | §二 业务数据同源、§三 后端配合、§五 与总库关系 | 一致 |
| 表现层钱包签、链上·用户签、13.1 前端/代付/资金边界 | 02 §六、§十三 13.1 | §一、§二、§五 与总库关系 | 一致 |
| 超时/争议窗口与前端展示一致、12 缝 #3 | 03、01 §10 12 缝 #3 | 开篇、§二 同源与超时/争议窗口（disputeDeadline≥autoCompleteAt） | 一致 |
| Phase 3/4 链与 DApp、05+06 配合 | 07 Phase 3/4 | 开篇与 01/02 对应、受众与用法、6.3 检查清单 | 一致 |
| 05 与 06 配合、dapp 目录与 openDispute | 05 开篇、§四 §七 §八 | 开篇 DApp 文档用法、§三 §四、§五 与总库关系表 | 一致 |

**06 与 01 总览主题符合性**（实现与审计时须与 01 总览主题保持一致）：

| 01 总览主题/约束 | 06 实现对应 | 所在节 |
|------------------|-------------|--------|
| DApp/钱包/EIP-712/代付 P0、UI 事实 | 钱包连接与签名、deposit/confirm/openDispute 须钱包签；EIP-712 Domain Separator 写死；不托管、不代签；已支付仅链上 Paid/对账 | §一、§三、§四、§五 |
| Web 与 DApp 业务数据同源 | 业务数据唯一来自 04 API；DApp 与 Web 共用同一 API、同一 Yew 应用 | §二 |
| 表现层、crates/web、dapp/ | DApp 为 05 crates/web 下 dapp/ 模块的架构展开；页面、路由、api/ 与 05 共用 | §一、§二、§五 |
| 链与合约边界、执行器代发 | 用户签由前端发起；裁决上链由后端执行器调合约，前端仅展示 | §一、§三、§四 |
| 12 缝 #11、17 条 #2/#14 | 钱包换绑与已支付订单、支付须经 deposit()、用户连点幂等 | §四 |
| 导游准入 Registry+Staking（方案 B） | 合约交互读 Registry 资格、Staking 余额；可接单由 API/链上共同决定 | §三、§四 |
| Created/Accepted EIP-712 签名留痕 | 01 §3、§5 十一、03 两步确认 | §三 签名与交易（若前端参与下单/接单） |
| 敏感操作展示（金额/代币/合约/取消） | 05 §九 9.0.5 | §五 安全 |

---

## 一、DApp 在本项目中的定位

| 维度 | 约定 |
|------|------|
| **与前端关系** | DApp 与「普通 Web」共用同一套 **Yew 前端**（crates/web，见 05 §四）；通过「是否连接钱包」区分模式，**不是独立应用**。 |
| **DApp 负责的事** | **连接钱包**、**用户签名**（支付旅行费用、质押、确认完成、**发起争议 openDispute**，01 §7 deposit/confirm/openDispute 须钱包签）、**与链上合约交互**；资金与关键状态在链上，平台不托管私钥（02 §十三 13.1 前端/代付、资金边界）。**代付（P0）**：默认不托管、不代签；代付为法务门禁例外路径（01 §7 代付 PR 触发法务门禁），DApp 实现以用户自签为准。 |
| **链与合约** | **已采用 EVM（以太坊 + L2）**，合约 Solidity（Escrow、Staking、Registry 方案 B，见 01 §4）；链下后端与前端用 Rust，通过 RPC/SDK 与链通信。 |

---

## 二、整体架构（简图）

```
                    ┌─────────────────────────────────────────────────────────┐
                    │                    用户（游客 / 导游）                     │
                    └───────────────────────────┬─────────────────────────────┘
                                                │
                    ┌───────────────────────────▼─────────────────────────────┐
                    │              前端 (Yew / WASM) — 同一应用                  │
                    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐
                    │  │ 普通 Web    │  │ DApp 模式   │  │ 共用：页面、路由、   │
                    │  │ 调 API 即可 │  │ 连钱包+签名 │  │ API 模块、业务 UI   │
                    │  └──────┬──────┘  └──────┬──────┘  └─────────────────────┘
                    └────────┼───────────────┼─────────────────────────────────┘
                             │               │
         ┌───────────────────┘               └───────────────────┐
         │                                                         │
         ▼                                                         ▼
┌─────────────────┐                                    ┌─────────────────────┐
│  后端 API       │                                    │  用户钱包            │
│  认证、订单、   │                                    │  MetaMask /          │
│  导游、争议     │                                    │  WalletConnect 等    │
│  读写 DB        │                                    │  用户签名 → 链上执行  │
└────────┬────────┘                                    └──────────┬──────────┘
         │                                                        │
         ▼                                                        ▼
┌─────────────────┐                                    ┌─────────────────────┐
│  数据库          │                                    │  EVM 链              │
│  业务数据        │                                    │  Escrow / Staking    │
└─────────────────┘                                    │  等智能合约          │
                                                        └─────────────────────┘
```

| 模式 | 约定 |
|------|------|
| **普通 Web** | 前端只调 API，支付可由平台代付或第三方，不涉及钱包。 |
| **DApp** | 前端连接钱包 → 用户对「支付 / 质押 / 确认完成 / 发起争议」等操作**签名** → 交易发到链上，合约执行；前端或后端再读链状态与 API 一起展示结果。 |

**DApp 与 Web 业务数据同步（P0）**（与 05 §二 一致）：业务数据**唯一数据源 = 04 API**（01 §9）；DApp 与 Web **共用同一 API**，不因钱包分源。链上仅负责支付/质押/确认/openDispute 等钱包签；业务展示以 API 为准。同一订单在 Web 与 DApp 页行程/接待人/状态须一致；订单详情、导游、行程**一律从 API 获取**。超时/争议窗口以 01、[03-业务流程与风控](03-业务流程与风控.md) 定稿为准（争议窗口 disputeDeadline≥autoCompleteAt，01 §10 12 缝 #3），前端从 API 获取并展示。

---

## 三、DApp 侧核心组成

| 层级 | 职责 | 实现要点 |
|------|------|----------|
| **钱包连接** | 检测/连接用户钱包、获取地址与链 ID | 标准接口：注入型（如 `window.ethereum`）、WalletConnect；兼容所有市场钱包，不自研钱包。登录/签名可选 **SIWE**（01 §7 P1），与 05 一致。 |
| **签名与交易** | 构造交易参数、唤起钱包签名、提交交易 | **订单创建/接单**（Created/Accepted）若在前端参与，须 EIP-712 签名留痕（01 §3、§5 十一、03）；与 05、04 API 一致。支付（**deposit(orderId, amount)**，直转不算，01 §10 17 条 #2）、质押（Staking）、确认完成（Escrow）、**openDispute**（01 §7 须钱包签）；可用 alloy/ethers 等库或前端 wallet provider 发起。 |
| **合约交互** | 读链上状态、提交已签名交易 | 读：Escrow 状态、Staking 余额、**Registry 资格**（方案 B，见 01 §4）、订单是否已支付/已放款；写：仅通过用户签名或授权后的合约调用。 |
| **后端配合** | 订单/争议等业务数据、裁决上链 | API 提供订单与合约地址/参数；**裁决执行由后端执行器调合约**（01 执行器 P0），前端仅展示状态与 tx 链接。 |

---

## 四、典型数据流（DApp）

1. **游客支付**：API 取 Escrow 地址与金额 → 唤起钱包 → 用户签 **deposit(orderId, amount)**（须经 deposit，直转不算，01 §10 17 条 #2）→ 上链 → 轮询/监听更新状态。**UI 事实（P0）**：已支付仅依据链上 Paid/对账；pending 可展示 confirmations。
2. **导游质押**：API 取 Staking 地址与最低金额 → 用户签授权+质押 → 上链 → 后端读链更新可接单资格。
3. **确认完成/争议执行**：用户通过前端签名触发合约放款，或超时自动放款（01/03）；裁决后由**后端执行器**调合约退款/扣罚，前端仅展示状态与 tx 链接。
4. **发起争议（openDispute）**：Escrowed 下先调 API 提交争议与证据，再 dapp/escrow 唤起钱包签 openDispute（付 arbFee）；01 §7、05 §七。

**12 缝 #11**：Paid 后换钱包=dispute 或新单；**17 条 #14**：支付/确认/openDispute 防重复提交，与后端幂等键及 orderId+action 一致。见 01 §10、05 §六 §七。

---

## 五、技术要点小结与总库关系

| 项目 | 约定 |
|------|------|
| **链** | 已采用 **EVM（以太坊 + L2）**，合约 Solidity（Escrow、Staking、Registry 方案 B，见 01 §4）；链下 Rust（API + Yew）通过 RPC + alloy/ethers 与链交互。 |
| **钱包** | 不托管私钥，仅连接用户已有钱包；标准 EIP-1193 / WalletConnect，兼容所有主流钱包。 |
| **安全** | 签名前明确展示「支付对象与金额」、**合约/订单标识**，用户可取消/拒绝（与 05 §九 9.0.5 敏感操作一致）；**EIP-712** 结构化签名（Domain Separator 写死，01 §7 P0）；不引导无限授权。 |

**与总库/文档关系**（与 05 §八 对应）：

| 文档 | 关系 |
|------|------|
| [01-总库总览](01-总库总览.md) | 业务与数据形态、链与代付 P0、§7 DApp/钱包/UI 事实、§9 同源、§10 12 缝/17 条；本文为 DApp 侧落实。 |
| [02-架构设计](02-架构设计.md) | 表现层 = crates/web；分层与「链上·用户签 vs 执行器代发」、§十三 13.1 前端/代付与资金边界。 |
| [03-业务流程与风控](03-业务流程与风控.md) | 超时/争议窗口与前端展示一致；业务规则定稿见 01/03。 |
| [04-后端与API](04-后端与API.md) | 业务数据以 04 API 为**唯一来源**；订单/导游/争议/档期、Escrow 地址与参数从 API 获取。 |
| [05-前端总览](05-前端总览.md) | 本文为 05 中 **dapp/** 模块的架构总览；页面、路由、api/ 与 05 共用；做 DApp 功能时 05 为主、06 为辅。 |
| [07-开发流程与顺序](07-开发流程与顺序.md) | Phase 3（链对接）、Phase 4（前端与 DApp）须同时参 06；业务数据同源在 Phase 4 须满足。 |

---

## 六、企业级审计标注

与 [01-总库总览](01-总库总览.md) §10 审计前检查清单及 [07-开发流程与顺序](07-开发流程与顺序.md) 阶段衔接。

### 6.1 审计维度与核对要点

| 维度 | 说明 | 06 落点 |
|------|------|---------|
| 与 01/02/03/04/05/07 一致性 | 01 §7/§9/§10（12 缝 #3/#11、17 条 #2/#14）、02 §十三 13.1、03 超时/争议窗口、04 唯一来源、05+06 配合及 §九 敏感操作、07 Phase 3/4 | 开篇两表、§一～§五 |
| DApp 职责边界 | 仅表现层：钱包/用户签、不代付不持私钥、业务数据唯一来自 API、裁决执行器代发 | §一、§二、§三、§四 |
| 安全与 02 §十三 13.1、05 §九 | EIP-712 写死、UI 事实 P0、DB 不因前端成功写 Paid；签名前展示金额/代币/合约/订单、可取消拒绝（05 §九 9.0.5） | §三、§四、§五 |
| 文档控制 | 受众、文档维护责任、版本见 00、变更同步 01/02/04/05 | 开篇受众与用法 |

### 6.2 企业级审计报告

**审计范围**：06 全文与 01/02/03/04/05/07 可追溯性、开篇受众与用法及两表、§一～§五、01 §7/§10 与 02 §十三 13.1 落点、文档控制、引用链接。**审计依据**：01（§7/§9/§10）、02（表现层、§八、§十三 13.1）、03、04、05、07、00。

**逐项审计结果**：01/02/03/04/05/07 引用 06 或 DApp 处均在 06 有落点（开篇表、§一～§五）；06 与 01 关键一致性及总览主题符合性两表结论一致；DApp 职责边界、17 条 #2/#14 与 12 缝 #11、02 §十三 13.1 落点、文档控制、引用链接—**均通过**。

**审计结论**：**通过**。06 满足企业级可追溯性、与 01～07 一致性、DApp 职责边界与文档控制要求；可作为 DApp 实现及与 05、04 对接依据。变更后须同步 01 §7/§10、02 §十三 13.1、05、04 并更新开篇表及本报告。

**瘦身后审计**：开篇合并为「受众与用法」、§二 业务数据同步改为段落、§四 数据流与 12 缝/17 条合并、§六 原 6.1～6.4 合并为 6.1～6.3。复核 01/02/03/04/05/07 引用 06 及 DApp 的每条落点、开篇两表、§一～§五 必要项均保留，**无缺口**，结论维持**通过**。

**深度多维度审计**（本次）：  
① **可追溯性**：01/02/03/04/05/07 中凡引用 06 或 DApp 的条款均在 06 有对应节或表项（开篇两表、§一～§五、与总库关系表）。  
② **02 §十三 13.1 全项**：前端/代付（后端不持私钥、不代签；代付需法务门禁）、资金边界（DB 不因前端成功写 Paid）— 06 §一 已补「代付为法务门禁例外路径（01 §7）」；§四 UI 事实、6.1 安全行已覆盖资金边界。  
③ **01 §7 代付 P0**：默认不托管、不代签、**代付 PR 触发法务门禁** — 06 §一「DApp 负责的事」已补代付法务门禁；开篇一致性表「DApp/钱包/EIP-712/代付 P0」含代付口径。  
④ **03 与 12 缝 #3**：超时/争议窗口与前端展示一致、disputeDeadline≥autoCompleteAt — §二 已载明；6.3 检查清单已增「01 §10 #3」「03 超时/争议窗口」项。  
⑤ **05 §九 9.0.5 敏感操作**：签名前展示金额/代币/合约/订单、取消/拒绝 — §五 安全、总览主题符合性表、6.1 安全行已载明；6.3 已列 04/05/07 含「05 §九 9.0.5」。  
⑥ **01 Created/Accepted EIP-712**：§三 签名与交易、总览主题符合性表已载明。  
⑦ **文档控制与引用**：受众、文档维护责任、版本见 00、变更同步 01/02/04/05 已载明；01/02/03/04/05/07/00 链接有效。  
**发现与处置**：补 §一 代付法务门禁一句；补 6.3 检查清单「03 超时/争议窗口」行及 01 §10 #3 在 #2/#11/#14 行中的表述。  
**深度审计结论**：**通过**。06 经多维度检查无未闭合缺口；与 01～07 可追溯性、02 §十三 13.1 全项、01 §7 代付 P0、03/12 缝 #3、05 §九 9.0.5、文档控制均满足企业级要求。

### 6.3 开工前检查清单（DApp）

| 检查项 | 要求 |
|--------|------|
| 01 §7 | 钱包/SIWE、EIP-712 写死、UI 事实、**代付 P0（不托管、代付法务门禁见 01）**、deposit/confirm/openDispute 须钱包签已载明（§一、§三、§四、§五） |
| 01 §10 #2/#3/#11/#14 | 支付须经 deposit()；**12 缝 #3** 争议窗口 disputeDeadline≥autoCompleteAt 在 §二；钱包换绑与已支付订单、连点幂等在 §四；实现与 05 §六 §七 一致 |
| 02 §十三 13.1 | 前端/代付、资金边界（DB 不因前端成功写 Paid）已载明；实现与 05 一致 |
| 03 超时/争议窗口 | 超时/争议窗口与前端展示一致、12 缝 #3 在 §二 载明；实现与 01/03 定稿一致 |
| 04/05/07 | 业务数据从 API 获取；05 为主 06 为辅、05 §九 9.0.5 敏感操作见 §五 安全；Phase 3/4 参 06、Phase 4 业务数据同源 |

---

以上即 TravelTrust **DApp 架构设计总览**，便于与 01/02/03/04/05/07 及后端、合约对齐实现。

*本文与 [01-总库总览](01-总库总览.md)、[02-架构设计](02-架构设计.md)、[03-业务流程与风控](03-业务流程与风控.md)、[04-后端与API](04-后端与API.md)、[05-前端总览](05-前端总览.md)、[07-开发流程与顺序](07-开发流程与顺序.md) 配套。文档版本与最后更新见 [00-文档索引](00-文档索引.md)。*
