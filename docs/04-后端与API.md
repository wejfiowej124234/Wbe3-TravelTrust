# 后端与 API

本文汇总：**数据表与 core 类型**、**API 路由 v1**、**风控要点**、**落地顺序**。与 [01-总库总览](01-总库总览.md)、[02-架构设计](02-架构设计.md)、[03-业务流程与风控](03-业务流程与风控.md) 配套；P0 以 01 为准，实现与 02 分层一致。持久化支持 PostgreSQL 或分布式 DB。

**与 01/02 对应**：01 §2 用户与账号、01 §6 证据/隐私 → 本文用户表与证据；01 §7 权限与 RBAC → 路由与鉴权；01 §8 骨架 api/db/chain → 02 应用层+基础设施；01 §9 对账/执行器 → 本文落点。**业务数据同源**（01 §9、[05-前端总览](05-前端总览.md)、[06-DApp架构总览](06-DApp架构总览.md)）：订单、导游、行程、档期、争议与证据以本文 API 为**唯一来源**，Web 与 DApp 共用。

**内容与结构**：§一 数据表与 core 类型 · §二 数据模型（用户与业务表）· §三 API 路由 v1 · §四 后端设计要点（风控、持久化）· §五 落地顺序 · **§六 企业级审计标注**（含总览主题符合性表、6.1 审计维度、6.2 核对要点、6.3 审计报告、6.4 开工前检查清单、6.5 使用说明）。实现与审计前建议先读 01、02、03。

**受众与用法**：后端与 API 实现、前端/DApp 对接人。建议先读 01、02、03 再读本文；实现时与 [07-开发流程与顺序](07-开发流程与顺序.md) 配合。**文档维护责任**：后端或技术负责人；接口/表结构变更须同步 01/02/03 相关节及 05（接口与前端对接）；§五 落地顺序变更时建议同步 [07-开发流程与顺序](07-开发流程与顺序.md) §三。文档版本与最后更新见 [00-文档索引](00-文档索引.md)。

**04 与 01/02 关键一致性核对**（维护时以 01 为权威，04 不得与之冲突）：

| 核对项 | 01 位置 | 04 位置 | 结论 |
|--------|---------|---------|------|
| 注册/登录、个人中心、身份 P0-1、代付 P0 | 01 §2 用户与账号；01 §7 代付（后端不持私钥/不代签） | §二 2.1、§三 3.1/3.2、§四 用户与账号（含代付 P0） | 一致 |
| 状态机与副作用定稿（03/04 定稿） | 01 §1；03/04 定稿 | §二 2.2 orders、§四；与 02 分层一致 | 一致 |
| 证据/隐私/保留与删除 P0 | 01 §6 证据可用性、隐私 P0-4、保留与删除 | §一表与证据存储说明、§二、§四 持久化；见 01 §6、02 §六 | 一致 |
| RBAC 与 8 项、执行器 | 01 §7；02/04 RBAC 定稿 | §三 鉴权；对账与执行器见 01 §9、02 §七 | 一致 |
| 反刷/限流、证据 DoS P0 | 01 §4、01 §6 | §四 风控；与 01 §4、03 §二 一致 | 一致 |
| 订单状态仅链事件驱动 | 01 §3 链为准；01 §1 状态机 | §二 2.2 orders：资金相关状态仅由链上事件驱动 | 一致 |
| API 幂等（requestId/idempotency-key） | 01 §10 17 条 #14 | §四 API 幂等 | 一致 |
| 仓库骨架 api/db/chain | 01 §8 总库 | 本文为 api 层实现；与 02 应用层+基础设施对应 | 一致 |
| 分布式 DB 选型 | 01 §6 分布式 DB；选型见 04 | §四 持久化（PostgreSQL 或 CockroachDB/TiDB/YugabyteDB） | 一致 |
| Web 与 DApp 业务数据同源 | 01 §9；05、06 见 01 | 开篇「业务数据以本文 API 为唯一来源」 | 一致 |
| P1 法务/沟通/安全占位 | 01 §4 P1 占位见 04/法务 | §四；具体口径见 01 §4、法务 | 一致 |
| 12 缝/17 条/资损 runbook 后端落点 | 01 §10 12 缝、审计验收表 17 条、资损 runbook 至少 5 条 | §四、§五、6.2；见 01 §10、02 §十二 | 一致 |

**04 与 01 总览主题符合性**（实现与审计时须与 01 总览主题保持一致）：

| 01 总览主题/约束 | 04 实现对应 | 所在节 |
|------------------|-------------|--------|
| 用户与账号、注册/登录、个人中心 | 邮箱注册/登录、JWT/session、GET·PUT /api/v1/me、身份 P0-1 | §二 2.1、§三 3.1/3.2 |
| 数据库与证据、隐私、保留与删除 | 表与 core 类型、证据/隐私/保留 P0 见 01 §6、02 §六 | §一、§二、§四 |
| 权限与角色、RBAC 与 8 项 | 路由与鉴权、02/04 RBAC 定稿 | §三 |
| 仓库骨架 api/db/chain | 本文 api 层；与 02 应用层+基础设施对应 | 开篇、§五 |
| 对账、执行器、数据流与职责 | 对账与执行器见 01 §9、02 §七；业务数据同源 | 开篇、§五 |
| 状态机与副作用（03/04 定稿） | orders 与 01 §1 一致；与 02 分层一致 | §二 2.2、§四 |
| 反刷/限流、证据 DoS、Sybil 与评价 | 风控与 01 §4、03 §二 一致；评价仅终态 | §四、§二 2.2 reviews |

---

## 一、数据表与 core 类型对应

| 表名 | 说明 | core 类型 |
|------|------|-----------|
| users | 用户、角色、KYC | User, UserRole, KycStatus |
| guides | 导游资料与质押 | Guide, GuideStatus, ServiceType |
| orders | 订单与托管状态 | Order, OrderState |
| reviews | 评价与权重 | ReviewWeight |
| stakes | 质押记录 | StakeTier |
| disputes | 争议与裁决 | Dispute, DisputeResolution |

**说明**：core 类型为领域最小集合；§二 表结构含更多字段（如 users 的 nickname、avatar_url、default_wallet_address、email_verified_at 等），实现时可在 core 扩展或通过 DTO 与 §二 对齐。

证据原件存储与 01 §6 一致，可为**独立 evidence 表**或对象存储 + disputes/orders 关联（hash 入 disputes.evidence_hashes[]），实现时定稿。

---

## 二、数据模型（用户与业务表）

### 2.1 用户与账号（users）

- **users**：id, **email**, **password_hash**, **email_verified_at**（可选）, role (tourist \| guide \| arbitrator), kyc_status, **nickname**, **avatar_url**, **default_wallet_address**（绑定钱包，可选）, created_at, updated_at  
- 注册：邮箱 + 密码，可做邮箱验证（验证链接/验证码）、密码强度校验。登录：邮箱 + 密码 → JWT 或 session；登出、刷新 token 按实现选。**身份与订单所有者（P0-1）**：见 [01-总库总览](01-总库总览.md) §2。订单创建/接单时**签名钱包与主身份校验**与 01 §2 P0-1 一致（下单、争议、证据提交时校验签名钱包与主身份），实现时定稿。

### 2.2 业务表

- **guides**：user_id, city, languages[], service_types[], stake_amount, status (pending \| active \| suspended)  
  - 与 01 §4 导游准入、[02-架构设计](02-架构设计.md) 导游状态机一致；可接单条件见 01 §4、§10。
- **orders**：id, tourist_id, guide_id, amount, currency, status, escrow_at, completed_at（与链上/争议窗口对齐字段如 order_id/chain_id/escrow_address、trip_end_at、dispute_deadline 等见 01 §1、§5，表结构在实现时与 01 定稿一致）  
  - **status 枚举与 01 §1 订单状态机一致**：Created, Accepted, Escrowed, Completed, Disputed, Refunded, PartiallyRefunded, Slashed, Cancelled（终态与合法迁移见 01）；资金相关状态仅由链上事件驱动，见 01 §3、[02-架构设计](02-架构设计.md) §五/§六。**链上 transfer 失败**：transferFrom/approve/黑名单失败时 DB 保持 pending，不得仅因前端或代付成功置已支付，见 [01-总库总览](01-总库总览.md) §5。
- **reviews**：order_id, reviewer_id, reviewee_id, score, weight, comment, created_at  
  - 仅订单资金终态（Completed 或争议已关闭且执行完毕）可提交评价，见 01 §4、[03-业务流程与风控](03-业务流程与风控.md) §2.1。
- **stakes**：guide_id, amount, locked_until, slashed_amount  
  - 与 01 §4 Staking、[02-架构设计](02-架构设计.md) 一致。
- **disputes**：order_id, status, evidence_hashes[], arbitrator_id, resolution (refund_ratio, slash_guide), resolved_at  
  - 仲裁费、裁决类型与执行器落点见 01 §5、01 §7、03 §3.2。
- **档期**：占档/解档与 01、03 状态机副作用一致；档期表或 guides/orders 扩展在实现时定稿。

---

## 三、API 路由规划（v1）

### 3.1 认证与账号

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /health | 健康检查；响应格式（纯文本如 `ok` 或 JSON 如 `{"status":"ok"}`）由实现与监控/负载均衡约定一致 |
| POST | /auth/register | **邮箱注册**（body: email, password；可选 nickname） |
| POST | /auth/login | **邮箱+密码登录**（返回 JWT 或 session） |
| POST | /auth/logout | 登出（使 token 失效或清 session） |
| POST | /auth/refresh | 刷新 token（若采用 JWT 刷新机制） |
| POST | /auth/verify-email | 邮箱验证（验证码或链接 token，按实现） |
| POST | /auth/forgot-password | 忘记密码（发重置链接/验证码） |
| POST | /auth/reset-password | 重置密码（token + 新密码） |

### 3.2 个人中心与设置

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/me | **当前用户信息** + 可选**统计摘要**（订单数、总收入、接待单数等，按角色返回） |
| PUT | /api/v1/me | 更新资料：昵称、头像、绑定/解绑钱包地址等 |
| PUT | /api/v1/me/password | 修改密码（需旧密码或已登录态） |

**KYC**：状态见 §二 users.kyc_status；提交/查询等预留接口在 Phase 4 由实现定稿，见 §五。

统计摘要（GET /api/v1/me 或 /api/v1/me/stats）：**游客**—订单数/总消费/评价数；**导游**—接待单数、完成单数、总收入（链上放款或订单汇总）、评分；**仲裁员**—裁决数（可选）。

### 3.3 导游、订单、争议

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/guides | 导游列表（筛选：city, language, service_type） |
| GET | /api/v1/guides/:id | 导游详情（下单/订单页用） |
| POST | /api/v1/guides | 导游注册（需登录） |
| POST | /api/v1/guides/:id/stake | 质押（MVP 可记 DB） |
| POST | /api/v1/orders | 下单（创建订单 + 锁定逻辑） |
| GET | /api/v1/orders | 我的订单列表（按当前用户角色过滤） |
| GET | /api/v1/orders/:id | 订单详情 |
| POST | /api/v1/orders/:id/accept | **导游接单**（Created→Accepted） |
| POST | /api/v1/orders/:id/cancel | **取消订单**（规则与超时见 01/03） |
| POST | /api/v1/orders/:id/confirm-completion | 确认完成 → 放款 + 可评价 |
| GET | /api/v1/orders/:id/reviews | 该订单评价 |
| POST | /api/v1/orders/:id/reviews | 提交评价（仅资金终态：Completed/Refunded/PartiallyRefunded/Slashed，带权重） |
| POST | /api/v1/orders/:id/dispute | 发起争议 |
| GET | /api/v1/disputes | 争议列表（仲裁员） |
| GET | /api/v1/disputes/:id | 争议详情（含证据引用） |
| POST | /api/v1/disputes/:id/resolve | 裁决 |

**支付与链上**：链上支付状态由 indexer 消费事件同步，不对外暴露 callback；若有支付网关 webhook，路径由实现定稿，与 01 §3 链为准、对账一致。

**证据**：上传与 pre-signed URL 获取与 01 §6 一致，具体路径在实现时定稿（如 `POST/GET /api/v1/orders/:id/evidence` 或 disputes 子资源）；工单内可读、每次读审计见 §四。

---

## 四、后端设计要点（crates/api）

- **运行时参数与 08-3 SSOT**：业务参数（仲裁费、证据保留期、争议窗口、finalityN、stakeTierThresholds 等）以 [08-3-参数与门禁表](08-3-参数与门禁表.md) 为单源真相；Backend 启动须加载或校验 08-3 约定版本/关键 key，见 [08-5-CI与一致性落地说明](08-5-CI与一致性落地说明.md) §4、[Runbook §10](../ops/RUNBOOK.md)。实现落点：配置或 env 注入 SSOT 版本/参数，启动时校验或打印；无校验时须在 Runbook §10 注明「待实现」并留痕。**当前 Backend 启动 SSOT 校验已实现**，见 Runbook §10。**Backend 环境变量**（PORT、CORS_ORIGINS、SSOT_VERSION、STRICT_SSOT）见仓库根 [.env.example](../.env.example) 与 Runbook §10；**生产必须设置 CORS_ORIGINS** 限制允许的 origin，否则存在跨域风险。**请求体与超时**：请求体大小上限（建议 1MB，与证据 DoS 风控一致）、请求超时（实现时定稿，便于限流与资源保护）须在实现时配置并与运维约定。
- **路由**：**认证与账号**（注册、登录、登出、邮箱验证、找回/重置密码）、**个人中心**（GET·PUT /api/v1/me、修改密码）、导游、订单（含接单、取消、确认完成）、争议、证据与支付/链上（见 §三）；支付回调由实现定稿，与 01 §3 链为准一致。
- **用户与账号**：注册邮箱+密码；登录态 JWT 或 session；`/api/v1/me` 返回用户资料与按角色统计（见 §三 3.2）。总收入可对账链上放款或由订单表汇总。**身份 P0-1**：下单/接单/争议/证据提交时签名钱包与主身份校验与 01 §2 一致，实现时定稿。**代付（P0）**：后端不持私钥、不代签、不接受用户转后端；已支付仅来自链上 Paid/对账；代付若启用须法务门禁，见 [01-总库总览](01-总库总览.md) §7。
- **风控**：与 01 §4、[03-业务流程与风控](03-业务流程与风控.md) §二 一致。**Sybil**：同设备/IP 多导游账号可限或人工复核。**评分权重**：`weight = f(订单金额, 导游历史信誉, 账户年龄)`，在 `core` 实现（03 §2.3）。**反刷/限流（P0）**：rate limit、黑名单与冻结阈值见 01 §4。**证据 DoS（P0）**：大小/类型白名单见 01 §6、02 §六。**证据上传与访问（P0）**：pre-signed URL、工单内可读、每次读审计与 01 §6 访问 P0 一致，接口在实现时与 01 §6、02 §六 定稿。**证据可用性（P0-3）**：重建工具、存储不可用/证据已删除时 SLA 与公平性口径见 01 §6，实现时定稿。**黑名单**：导游/用户 ID 表，下单/接单前校验。**allowlist**：token/合约 allowlist 校验与 01 §5 一致，后端不绕过 allowlist（见 01 禁止行为）。
- **API 幂等**：重试/连点用 requestId 或 idempotency-key，与 01 §10 17 条 #14 一致。当前 API 已读取 Idempotency-Key/X-Idempotency-Key 并回写响应头；**实现时对写操作须校验 idempotency-key 并做 key 去重与结果复用**，落 17 条 #14 证据产物（如 idempotency 日志）。
- **持久化**：trait 抽象（`UserRepository`、`OrderRepository`），支持 PostgreSQL 或分布式 DB（CockroachDB/TiDB/YugabyteDB 等），SQL 尽量标准。证据/隐私/保留与删除 P0 见 01 §6、02 §六。**对账**：对账任务/脚本与 01 §9、[02-架构设计](02-架构设计.md) §十二 一致；**事件表、checkpoint、投影**与 01 §5、02 §十二 一致（event 表 blockHash+blockNumber+logIndex，投影可重建）；主状态仅由链上事件驱动、correction 与投影分离见 01 §10 17 条 #12。**DB 全丢重建（P0-6）**：最小产物与脚本见 01 §9，与事件投影可重建一致。**可观测**：traceId 贯通 requestId→messageId→txHash→logIndex，与 01 §9 一致，便于审计导出与资损排查。API 响应头 x-request-id 即 requestId；对账/执行器消费消息时 **messageId 与 x-request-id 的关联方式**（透传或映射规则）由实现定稿并留痕，见 01 §9。#15 对账三段式、#16 状态机与副作用落点见 §二、§四、01 §9。**SLO（P0-7）**：六项指标+阈值与动作见 01 §9，后端/对账侧与 02 §十二 配合定稿。**RBAC 8 项**：选项与证据产物见 01 §7，鉴权与路由在 §三 实现时定稿。**系统级不变量**：与 01 §10 一致，后端设计不与之冲突。**12 缝后端相关**：#2 争议费用/#3 争议窗口/#10 证据时间戳/#11 钱包换绑/#12 取消矩阵与 01 §10 定稿一致，落点见 §二、§三、§四及 03；**具体数值与选项**以 [01-总库总览](01-总库总览.md) §10 12 缝表为准，实现时定稿。**资损 runbook（P0）**：至少 5 条（① RPC 大面积不可用；② Indexer 落后；③ reorg 触发撤销；④ 执行器卡单；⑤ token 冻结/黑名单导致结算失败），见 01 §9 发布与 E2E；后端/对账侧责任与 [07-开发流程与顺序](07-开发流程与顺序.md) 或运维 runbook 配合定稿。**17 条证据产物**：后端产出物（如 `correction_log`、`reconciliation_rules.json`、API `idempotency_key` 日志、执行器审计表等）与 01 §10 审计验收表一致，实现时定稿。**P1 占位**：沟通/安全/费用税务见 01 §4、法务。

---

## 五、落地顺序建议

**Phase 0（架构锁定）、Phase 5（风控与运营就绪）** 定义及产出见 [07-开发流程与顺序](07-开发流程与顺序.md) §二；本文以下为 Phase 1～4。

1. **Phase 1**：Rust workspace + `core` 类型 + `api` 骨架 + 基础 CRUD（用户、导游、订单状态机）。
2. **Phase 2**：Escrow 流程（下单锁定、完成放款）、评价与权重、Staking 表与接口。
3. **Phase 3**：争议与仲裁、前端三端主流程。
4. **Phase 4**：支付对接（稳定币）、KYC 预留、链上接口对接（按需）。

先链下 MVP 再逐步上链。**对账与执行器**见 01 §9、[02-架构设计](02-架构设计.md) §七。**资金坏链路（P0-5）**：executeResolution 原子执行；transfer 失败→Disputed+retry，超 N 次→工单+告警；禁止线下转账改状态；见 [01-总库总览](01-总库总览.md) §5、§9。完整阶段及与本文 Phase 的对照见 [07-开发流程与顺序](07-开发流程与顺序.md) §二、§三。

---

## 六、企业级审计标注

以下为本文与 01/02/03 的**企业级审计检查记录**；实现或定稿前按表逐项确认。**权威口径**：01 业务与硬约束、02 架构、03 业务规则；本文为后端与 API 实现，不得与 01/02/03 冲突。**审计维度与核对要点**见 **6.1**、**6.2**；**本轮企业级审计报告**见 **6.3**。

**审计结论**：本文已通过可追溯性、P0 覆盖、与 01/02/03 一致性、总览主题符合性、文档控制及引用链接等企业级检查。检查日期与文档版本见 [00-文档索引](00-文档索引.md)。

### 6.1 审计维度与结果

| 审计维度 | 检查项 | 结果 | 本文落点 |
|----------|--------|------|----------|
| **可追溯性** | 01 中凡引用 04 处，本文均有对应 | ✅ 通过 | 开篇、§二～§五、一致性表 12 项；逐项见 6.2 |
| **P0 覆盖** | 01 后端相关 P0 在 04 有引用或承接 | ✅ 通过 | 身份 P0-1、代付 P0、状态机、链事件驱动、反刷/限流、证据 DoS、证据/隐私/保留、证据 P0-3、API 幂等、RBAC、执行器 P0、资金坏链路 P0-5、DB 全丢重建 P0-6（见 01 §9）；allowlist 不绕过（01 §5）；§二、§四、§五、一致性表 |
| **与 01 一致性** | 订单状态、资金仅链驱动、评价仅终态、争议/执行器、风控与 01 一致 | ✅ 通过 | §二 2.2、§四；开篇一致性表 12 项、总览主题符合性表 7 行 |
| **与 02 一致性** | 分层、事件消费、对账、执行器、证据边界与 02 一致 | ✅ 通过 | 开篇、§四 持久化、§五 对账与执行器；02 引用 04 处均已覆盖 |
| **与 03 一致性** | 接口与风控与 03 业务规则定稿前确认对齐 | ✅ 通过 | §二 reviews/disputes、§四 风控与 03 §二、§三 引用一致；03 §四「与 04 接口与风控对齐」已满足 |
| **文档控制** | 受众、维护责任、版本见 00、变更同步 01/02/03 | ✅ 通过 | 开篇受众与用法、维护责任、版本见 00 |

### 6.2 与 01/02/03 核对要点

- **01 引用 04**：§1 状态机/03/04 定稿 → §二 2.2、§三、§四；§2 注册/个人中心 → §二 2.1、§三 3.1/3.2；§4 反刷/证据 DoS/P1 → §四；§5 链上 transfer 失败→DB pending、事件表、**禁止后端绕过 allowlist** → §二 2.2、§四 对账与 allowlist；§6 证据/隐私/保留/分布式 DB → §一、§二、§四；§7 RBAC/8 项/代付 P0 → §三、§四；§8 骨架 → 本文 api 层；§9 对账/执行器/同源/SLO/traceId、P0-6 → 开篇、§四、§五。**17 条后端相关**：#12 DB 状态仅链事件驱动、#14 幂等、#15 对账三段式、#16 状态机与副作用 → §二、§四、§五及 01 §9。
- **02 引用 04**：受众、骨架、RBAC、后端路由与风控、对账落地、17 条落在 04/07、§十三 定稿 — §二～§五 及开篇表已覆盖。
- **03 引用 04**：反刷限流见 04、证据保留落地见 04、业务规则定稿前与 04 接口风控对齐 — §四 风控、§四 持久化与 03 §二/§三 一致。
- **01 §10 与 04**：**12 缝**中后端相关与 01 定稿一致，具体数值以 01 §10 12 缝表为准，落点见 §二、§四及 03。**17 条**后端相关 #12/#14/#15/#16 见上；**证据产物**与 01 §10 审计验收表一致，见 §四。**资损 runbook** 5 条、**证据 P0-3** 见 §四。**资金坏链路 P0-5**（executeResolution 原子、transfer 失败处置）见 §五、01 §5/§9。

### 6.3 企业级审计报告（本轮）

以下为逐项审计结果汇总；审计维度与核对要点见 6.1、6.2。

| 项目 | 内容 |
|------|------|
| **审计日期** | 见 [00-文档索引](00-文档索引.md) 文档版本与最后更新 |
| **审计范围** | 04 全文与 01/02/03 的可追溯性、P0 覆盖（含 P0-5/P0-6）、一致性表 12 项、总览主题符合性表 7 行、01 §10 12 缝/17 条/资损 runbook 后端落点、文档控制、引用链接 |
| **审计依据** | 01 总库总览（§1～§10）、02 架构设计（§六/§七/§十三）、03 业务流程与风控（§二/§三/§四）、00 文档索引 |

**逐项审计结果**：

| 审计项 | 审计方法 | 结果 | 备注 |
|--------|----------|------|------|
| 01 引用 04 可追溯 | 逐条核对 01 中「见 [04]」「03/04 定稿」「02/04 RBAC 定稿」等 → 04 对应节 | ✅ 通过 | §1→§二 2.2、§三、§四；§2→§二 2.1、§三 3.1/3.2；§4→§四；§5→§二 2.2 transfer 失败→DB pending、§四 对账；§6→§一、§二、§四；§7→§三、§四 代付 P0；§8→开篇；§9→开篇、§四、§五 |
| P0 覆盖 | 01 后端相关 P0（身份、代付、状态机、链事件驱动、反刷/限流、证据 DoS、证据/隐私/保留/P0-3、API 幂等、RBAC、执行器、资金坏链路 P0-5、P0-6）在 04 有引用或承接 | ✅ 通过 | §二、§四、§五、开篇一致性表；代付/执行器/P0-5/P0-6 见 §四、§五、01 §9 |
| 04 与 01 关键一致性 | 开篇「04 与 01/02 关键一致性核对」12 项与 01 定稿逐项对照 | ✅ 通过 | 12 项结论均为「一致」 |
| 04 与 01 总览主题符合性 | 开篇「04 与 01 总览主题符合性」表 7 行与 01 总览主题对照 | ✅ 通过 | 无冲突 |
| 04 与 02 一致性 | 分层、对账、执行器、证据边界与 02 §六/§七/§十三 表述一致 | ✅ 通过 | 开篇、§四、§五；02 引用 04 处均已覆盖 |
| 04 与 03 一致性 | 接口与风控与 03 §二/§三/§四「与 04 接口与风控对齐」一致 | ✅ 通过 | §二 reviews/disputes、§四 风控 |
| 文档控制 | 受众、维护责任、版本见 00、变更同步 01/02/03 已载明 | ✅ 通过 | 开篇受众与用法 |
| 内部一致性 | 节号§一～§六、子节 2.1/2.2、3.1～3.3、开篇表 12+7 与正文一致 | ✅ 通过 | 无矛盾 |
| 12 缝/17 条/资损 runbook 后端落点 | 01 §10 12 缝、17 条、资损 runbook、证据 P0-3 在 04 有引用或落点 | ✅ 通过 | §四 12 缝/资损/证据 P0-3；6.2、§五 17 条与对账；开篇一致性表第 12 项 |
| 引用链接 | 01/02/03/05/06/07/00 链接有效、无断链 | ✅ 通过 | 文内与文末 |
| 代付 P0 / SLO / 系统级不变量 / P0-5 | 代付 P0、SLO P0-7、系统级不变量、资金坏链路 P0-5 与 01 一致 | ✅ 通过 | §四 代付 P0、SLO、系统级不变量；§五 资金坏链路 P0-5；01 §5、§7、§9、§10 |

**发现的问题与处置**：无。开篇一致性表 **12 项**（含代付 P0 并入第一项）、总览主题符合性表 7 行与 01 定稿对齐；§二 stakes 已补与 01 §4、02 一致。已补：§三 接单/取消、导游与争议详情、支付与证据说明、KYC 占位；§二 档期、orders 链上对齐、链上 transfer 失败→DB pending、身份 P0-1 签名校验；§一 证据存储说明；§四 路由、对账落点、身份 P0-1、代付 P0、事件表/checkpoint/投影、traceId、allowlist 不绕过、DB 全丢重建 P0-6、SLO P0-7、RBAC 8 项、系统级不变量、证据 P0-3、12 缝、资损 runbook、17 条证据产物；§五 **资金坏链路 P0-5**（executeResolution 原子、transfer 失败处置）；6.4 与 01 §10 审计前检查清单衔接；与 01 §5/§6/§7/§9/§10 一致。

**审计结论**：**通过**。04 满足企业级可追溯性、P0 覆盖、与 01/02/03 一致性、总览主题符合性、**01 §10 12 缝/17 条/资损 runbook/证据 P0-3 后端落点**、文档控制及引用链接要求；可作为后端与 API 实现及与 03 业务规则定稿前对齐依据。接口或表结构变更后须同步 01/02/03 并重核开篇表与 §六、更新本报告。

### 6.4 开工前检查清单（企业级）

与 [01-总库总览](01-总库总览.md) §10 审计前检查清单（12 缝、17 条、资损 runbook、系统级不变量）衔接；开工前与接口/表结构定稿前各做一次勾选；任一项不满足须在 01/02/03 或合约中定稿后再通过。

| # | 检查项 | 要求 |
|---|--------|------|
| 1 | 01 引用 04 覆盖 | 开篇「与 01/02 对应」、一致性表 **12 项**及 §二～§四 均已覆盖；01 §10 12 缝/17 条/资损 runbook 后端落点见 §四、6.2 |
| 2 | 04 与 01/02 一致性 | 开篇「04 与 01/02 关键一致性核对」**12 项**无冲突；总览主题符合性表 7 行与 01 一致 |
| 3 | 与 03 接口风控对齐 | §二 业务表、§四 风控与 03 §二、§三 引用一致；03 §四「与 04 接口与风控对齐」已满足 |
| 4 | 规则变更同步 | 04 修改后已同步 01/02/03 相关节，并更新开篇两表及 6.3（若 01/02/03 条号变更） |

### 6.5 使用说明

- **审计前**：按 6.1 逐项勾选，核对开篇一致性表与总览主题符合性表与 01 定稿；6.3 可作本轮审计记录；**6.4 开工前检查清单**开工前与定稿前各勾选一次。
- **规则变更**：修改 04 后须同步 01/02/03，并更新开篇一致性表、总览主题符合性表及 6.3 审计报告（若 01/02/03 条号或引用变更）。
- **版本**：检查日期与文档版本见 [00-文档索引](00-文档索引.md)。

---

*本文与 [01-总库总览](01-总库总览.md)、[02-架构设计](02-架构设计.md)、[03-业务流程与风控](03-业务流程与风控.md)、[05-前端总览](05-前端总览.md)、[06-DApp架构总览](06-DApp架构总览.md)、[07-开发流程与顺序](07-开发流程与顺序.md) 配套。文档版本与最后更新见 [00-文档索引](00-文档索引.md)。*
